<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yuung Playlist â€” Full (Offline, PWA, IndexedDB)</title>
<meta name="theme-color" content="#0b7fa8" id="metaThemeColor">

<script src="https://unpkg.com/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>

<style>
Â  /* ============================
Â  Â DARK MODE â€“ Sá»­a lá»—i vÃ  Ã¡p dá»¥ng biáº¿n theme thá»‘ng nháº¥t
Â  Â ============================ */
/* Sá»­ dá»¥ng .dark-mode Ä‘á»ƒ ghi Ä‘Ã¨ cÃ¡c biáº¿n gá»‘c */
.dark-mode {
Â  Â  /* Ghi Ä‘Ã¨ cÃ¡c biáº¿n theme gá»‘c */
Â  Â  --bg1: #0e0e0e; /* Ná»n tá»‘i */
Â  Â  --bg2: #1a1a1a; /* Ná»n tá»‘i hÆ¡n */
Â  Â  --card: #1f1f1f; /* Ná»n card tá»‘i */
Â  Â  --text: #ffffff; /* Sá»¬A: MÃ u chá»¯ chÃ­nh pháº£i lÃ  biáº¿n --text */
Â  Â  --muted: #aaaaaa;
Â  Â  --shadow: 0 8px 30px rgba(0,0,0,0.6);
Â  Â  --glass: rgba(31, 31, 31, 0.7); /* Glassmorphism tá»‘i */
}

/* Ãp dá»¥ng mÃ u chá»¯ tráº¯ng cho má»i thá»©, Ä‘áº£m báº£o khÃ´ng bá»‹ ghi Ä‘Ã¨ */
.dark-mode body,
.dark-mode * {
Â  Â  color: var(--text) !important;
}

/* Ná»n container + card */
.dark-mode .container,
.dark-mode .music-item,
.dark-mode .music-card,
.dark-mode .playlist,
.dark-mode .card {
Â  Â  background: var(--card) !important;
Â  Â  border-color: rgba(255,255,255,0.2) !important;
}

/* Input + button */
.dark-mode input,
.dark-mode button {
Â  Â  background: #2a2a2a !important;
Â  Â  color: var(--text) !important;
Â  Â  border-color: rgba(255,255,255,0.2) !important;
}


Â  /* ============================
Â  Â  Â THEME & LAYOUT - Cáº£i tiáº¿n mÃ u sáº¯c vÃ  shadow
Â  Â  Â ============================ */
Â  :root{
Â  Â  --bg1: #f7f9fb; /* Ná»n sÃ¡ng dá»‹u hÆ¡n */
Â  Â  --bg2: #eceef1;
Â  Â  --card: #ffffff;
Â  Â  --muted: #6b8b92;
Â  Â  --text: #043242;
Â  Â  --accent: #ff4757;
Â  Â  --accent2: #00a6ff;
Â  Â  --glass: rgba(255,255,255,0.7); /* Glassmorphism sÃ¡ng */
Â  Â  --radius: 16px;
Â  Â  --shadow: 0 10px 30px rgba(3,50,64,0.12); /* Shadow rÃµ rÃ ng hÆ¡n */
Â  Â  --shadow-hover: 0 12px 35px rgba(3,50,64,0.18);
Â  }
Â  /* Loáº¡i bá» Ä‘á»‹nh nghÄ©a [data-theme="dark"] vÃ¬ Ä‘Ã£ dÃ¹ng class .dark-mode Ä‘á»ƒ thá»‘ng nháº¥t */

Â  html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
Â  .wrap{max-width:1100px;margin:20px auto;padding:18px}
Â  header{display:flex;align-items:center;gap:14px;padding:14px;border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
Â  .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:800}
Â  h1{margin:0;font-size:24px; /* TÄƒng kÃ­ch thÆ°á»›c tiÃªu Ä‘á» */ }
Â  .subtitle{font-size:14px;color:var(--muted)}

Â  /* controls */
Â  .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
Â  .btn{background:var(--card);border:0;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);font-size:14px;font-weight:600;}
Â  .btn:hover{transform:translateY(-2px); box-shadow:var(--shadow-hover);} /* ThÃªm hiá»‡u á»©ng hover */
Â  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700}
Â  .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

Â  .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
Â  @media (max-width:900px){ .grid{grid-template-columns:1fr; } }

Â  /* left column: player + add */
Â  .card{background:var(--card);border-radius:18px; /* TÄƒng nháº¹ radius */ padding:16px;box-shadow:var(--shadow)}
Â  .cover{width:100%;height:320px;border-radius:16px;background:linear-gradient(135deg,#ddd,#bbb);display:flex;align-items:center;justify-content:center;font-size:48px;color:white;font-weight:800;overflow:hidden}
Â  .meta{margin-top:16px}
Â  .meta h2{margin:0;font-size:20px}
Â  .meta .small{font-size:14px;color:var(--muted);margin-top:6px}

Â  .file-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
Â  label.file-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--card);cursor:pointer;border:1px dashed rgba(0,0,0,0.1);box-shadow:var(--shadow);}
Â  label.file-btn:hover{transform:translateY(-2px); box-shadow:var(--shadow-hover);} /* ThÃªm hiá»‡u á»©ng hover */
Â  input[type=file]{display:none}

Â  /* save offline toggle and storage status */
Â  .row{display:flex;align-items:center;gap:10px}
Â  .toggle{padding:8px 12px;border-radius:12px;background:var(--card);cursor:pointer;box-shadow:var(--shadow)}
Â  .status{font-size:13px;color:var(--muted)}

Â  /* right column: playlist */
Â  .playlist{display:flex;flex-direction:column;gap:10px}
Â  .search-row{display:flex;gap:8px;align-items:center}
Â  .search{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:transparent}
Â  .track{display:flex;align-items:center;gap:12px;padding:12px;border-radius:14px;background:var(--card);box-shadow:var(--shadow);cursor:pointer;position:relative}
Â  .track.playing{border:2px solid var(--accent2); padding:10px;} /* Chá»‰ bÃ¡o track Ä‘ang chÆ¡i */
Â  .track:hover{transform:translateY(-4px); box-shadow:var(--shadow-hover);}
Â  .track .t-cover{width:60px;height:60px;border-radius:8px;overflow:hidden;background:linear-gradient(135deg,#ddd,#ccc);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
Â  .track .t-info{flex:1;min-width:0}
Â  .t-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
Â  .t-sub{font-size:12px;color:var(--muted);margin-top:4px}

Â  .track .t-actions{display:flex;gap:6px}

Â  /* player controls group */
Â  .player-controls-group{display:flex;align-items:center;gap:12px;}
Â  .player-controls-group .btn{width:40px;height:40px;padding:0;display:flex;align-items:center;justify-content:center;font-size:18px;}
Â  .player-controls-group .btn.primary{width:56px;height:56px;font-size:24px;border-radius:16px;} /* NÃºt play to hÆ¡n */

Â  /* bottom player sticky - Ãp dá»¥ng Glassmorphism */
Â  .player-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:calc(100% - 60px);max-width:1100px;background:var(--glass); /* Ná»n má» */ backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); padding:12px;border-radius:18px;box-shadow:var(--shadow-hover);display:flex;align-items:center;gap:16px; border:1px solid rgba(255,255,255,0.1)}
Â  .dark-mode .player-bar{border:1px solid rgba(255,255,255,0.05)}

Â  .player-cover{width:60px;height:60px;border-radius:10px;overflow:hidden}
Â  .player-controls{display:flex;align-items:center;gap:8px}
Â  .seek{flex:1}
Â  .time{min-width:110px;text-align:right;font-size:13px;color:var(--muted)}

Â  /* small screens */
Â  @media (max-width:520px){
Â  Â  .cover{height:220px}
Â  Â  .player-bar{width:calc(100% - 28px);padding:10px;gap:10px}
Â  Â  .player-cover{width:48px;height:48px}
Â  Â  .player-controls-group .btn.primary{width:48px;height:48px;font-size:20px;}
Â  Â  .time{min-width:60px;}
Â  }

Â  /* micro transitions */
Â  .btn, .file-btn, .track{transition:all .2s ease}
</style>
</head>
<body>

<div class="wrap">
Â  <header>
Â  Â  <div class="logo">ğŸ§</div>
Â  Â  <div style="flex:1">
Â  Â  Â  <h1>Yuung Playlist</h1>
Â  Â  Â  <div class="subtitle">Offline-ready Â· PWA Â· Dark mode Â· Thumbnails Â· IndexedDB save</div>
Â  Â  </div>
Â  Â  <div style="display:flex;gap:8px">
Â  Â  Â  <button id="themeToggle" class="btn">ğŸŒ™</button>
Â  Â  Â  <button id="installBtn" class="btn">ğŸ“² Install</button>
Â  Â  </div>
Â  </header>

Â  <div class="controls" style="margin-top:14px">
Â  Â  <label class="file-btn" id="addFilesBtn">â• ThÃªm file
Â  Â  Â  <input id="fileInput" type="file" accept="audio/*" multiple />
Â  Â  </label>

Â  Â  <label class="file-btn" id="addCoverBtn">ğŸ–¼ï¸ ThÃªm cover (tÃ¹y chá»n)
Â  Â  Â  <input id="coverInput" type="file" accept="image/*" />
Â  Â  </label>

Â  Â  <div class="row" style="margin-left:auto;gap:8px">
Â  Â  Â  <div class="status" id="storageStatus">Offline files: 0</div>
Â  Â  Â  <button id="toggleSaveFiles" class="btn">ğŸ’¾ Save offline: Off</button>
Â  Â  </div>
Â  </div>

Â  <div class="grid">
Â  Â  Â  Â  <div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="cover" id="mainCover">ğŸµ</div>

Â  Â  Â  Â  <div class="meta">
Â  Â  Â  Â  Â  <h2 id="nowTitle">â€”</h2>
Â  Â  Â  Â  Â  <div class="small" id="nowMeta">ChÆ°a chÆ¡i bÃ i nÃ o</div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:12px">
Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;align-items:center">
Â  Â  Â  Â  Â  Â  
                <div class="player-controls-group">
                    <button id="prev" class="btn">â®</button>
                    <button id="play" class="btn primary">â–¶ï¸</button>
                    <button id="next" class="btn">â­</button>
                </div>
                Â  Â  Â  Â  Â  Â  <div style="flex:1;margin-left:8px">
Â  Â  Â  Â  Â  Â  Â  <input id="seek" type="range" min="0" max="100" value="0" class="seek" style="width:100%">
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div class="time" id="timeLabel">0:00 / 0:00</div>
Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
Â  Â  Â  Â  Â  Â  <button id="shuffleBtn" class="btn">ğŸ”€ Shuffle</button>
Â  Â  Â  Â  Â  Â  <button id="repeatBtn" class="btn">ğŸ” Repeat: Off</button>
Â  Â  Â  Â  Â  Â  <button id="exportBtn" class="btn">ğŸ“¤ Export</button>
Â  Â  Â  Â  Â  Â  <button id="importBtn" class="btn">ğŸ“¥ Import</button>
Â  Â  Â  Â  Â  Â  <button id="clearBtn" class="btn">ğŸ—‘ï¸ Clear</button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div style="margin-top:12px" class="card">
Â  Â  Â  Â  <div style="display:flex;align-items:center;justify-content:space-between">
Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  <strong>Storage</strong>
Â  Â  Â  Â  Â  Â  <div class="small">Báº¡n cÃ³ thá»ƒ lÆ°u file vÃ o bá»™ nhá»› cá»§a trÃ¬nh duyá»‡t (IndexedDB) Ä‘á»ƒ phÃ¡t offline.</div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div style="text-align:right">
Â  Â  Â  Â  Â  Â  <div id="idbUsage" class="small-muted">IDB: 0 files</div>
Â  Â  Â  Â  Â  Â  <div class="small-muted" id="quotaInfo"></div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
Â  Â  Â  Â  Â  <button id="saveAllBtn" class="btn">ğŸ’¾ Save all to IDB</button>
Â  Â  Â  Â  Â  <button id="removeAllSavedBtn" class="btn">ğŸ§¹ Remove saved files</button>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div>
Â  Â  Â  <div class="card">
Â  Â  Â  Â  <div class="search-row">
Â  Â  Â  Â  Â  <input id="search" class="search" placeholder="TÃ¬m trong playlist..." />
Â  Â  Â  Â  Â  <button id="downloadAll" class="btn">â¬‡ï¸ Download all</button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="playlist" style="margin-top:12px" class="playlist"></div>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
</div>

<div class="player-bar" id="playerBar" style="display:none">
Â  <div class="player-cover" id="barCover">ğŸµ</div>
Â  <div style="flex:1">
Â  Â  <div id="barTitle" style="font-weight:700">â€”</div>
Â  Â  <div id="barSub" class="small-muted">â€”</div>
Â  </div>
Â  <div class="player-controls">
Â  Â  <button id="barPrev" class="btn">â®</button>
Â  Â  <button id="barPlay" class="btn primary">â–¶ï¸</button>
Â  Â  <button id="barNext" class="btn">â­</button>
Â  </div>
Â  <div style="width:220px;margin-left:12px">
Â  Â  <input id="barSeek" type="range" min="0" max="100" value="0" style="width:100%">
Â  </div>
Â  <div class="time" id="barTime">0:00 / 0:00</div>
</div>

<script>
function toggleDarkMode() {
Â  Â  document.documentElement.classList.toggle("dark-mode");
Â  Â  localStorage.setItem("darkMode", document.documentElement.classList.contains("dark-mode") ? "1" : "0");
}
// Tá»± báº­t dark mode náº¿u láº§n trÆ°á»›c báº­t
if (localStorage.getItem("darkMode") === "1") {
Â  Â  document.documentElement.classList.add("dark-mode");
}
Â  /* ===================================================
Â  Â FULL APP SCRIPT
Â  Â - ThÃªm logic UI/UX cho CSS Ä‘Ã£ thay Ä‘á»•i
Â  Â =================================================== */

(async()=>{ // IIFE to keep scope

// ---------- State ----------
const STORAGE_KEY = 'yuung_meta_v3';
let tracks = []; // {id,name,size,type,coverBase64, saved:bool}
let runtimeFiles = new Map(); // id -> {file:File, url:objectURL}
let queue = [], idx = -1;
let shuffleMode = false, repeatMode = 'off';
let saveFilesOffline = false;

// ---------- DOM Refs ----------
const fileInput = document.getElementById('fileInput');
const coverInput = document.getElementById('coverInput');
const addFilesBtn = document.getElementById('addFilesBtn');
const addCoverBtn = document.getElementById('addCoverBtn');
const playlistEl = document.getElementById('playlist');
const nowTitle = document.getElementById('nowTitle');
const nowMeta = document.getElementById('nowMeta');
const mainCover = document.getElementById('mainCover');
const playBtn = document.getElementById('play');
const prevBtn = document.getElementById('prev');
const nextBtn = document.getElementById('next');
const seek = document.getElementById('seek');
const timeLabel = document.getElementById('timeLabel');
const shuffleBtn = document.getElementById('shuffleBtn');
const repeatBtn = document.getElementById('repeatBtn');
const exportBtn = document.getElementById('exportBtn');
const importBtn = document.getElementById('importBtn');
const clearBtn = document.getElementById('clearBtn');
const storageStatus = document.getElementById('storageStatus');
const toggleSaveFiles = document.getElementById('toggleSaveFiles');
const saveAllBtn = document.getElementById('saveAllBtn');
const removeAllSavedBtn = document.getElementById('removeAllSavedBtn');
const idbUsage = document.getElementById('idbUsage');
const downloadAllBtn = document.getElementById('downloadAll');
const searchInput = document.getElementById('search');
const installBtn = document.getElementById('installBtn');
const themeToggle = document.getElementById('themeToggle');

// bottom bar
const playerBar = document.getElementById('playerBar');
const barCover = document.getElementById('barCover');
const barTitle = document.getElementById('barTitle');
const barSub = document.getElementById('barSub');
const barPlay = document.getElementById('barPlay');
const barPrev = document.getElementById('barPrev');
const barNext = document.getElementById('barNext');
const barSeek = document.getElementById('barSeek');
const barTime = document.getElementById('barTime');

// audio
const audio = new Audio();
audio.setAttribute('playsinline','');

// ---------- IndexedDB helpers ----------
const IDB_DB = 'yuung_db_v1', IDB_STORE = 'files';

function openDB(){ return new Promise((res,rej)=>{
Â  const r = indexedDB.open(IDB_DB,1);
Â  r.onupgradeneeded = ()=> {
Â  Â  const db = r.result;
Â  Â  if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE, {keyPath:'id'});
Â  };
Â  r.onsuccess = ()=> res(r.result);
Â  r.onerror = ()=> rej(r.error);
});}

async function idbPut(id, blob, meta){
Â  const db = await openDB();
Â  return new Promise((res,rej)=>{
Â  Â  const tx = db.transaction(IDB_STORE,'readwrite');
Â  Â  tx.objectStore(IDB_STORE).put({id,blob,meta});
Â  Â  tx.oncomplete = ()=> res(true);
Â  Â  tx.onerror = ()=> rej(tx.error);
Â  });
}
async function idbGet(id){
Â  const db = await openDB();
Â  return new Promise((res,rej)=>{
Â  Â  const r = db.transaction(IDB_STORE).objectStore(IDB_STORE).get(id);
Â  Â  r.onsuccess = ()=> res(r.result);
Â  Â  r.onerror = ()=> rej(r.error);
Â  });
}
async function idbGetAllKeys(){
Â  const db = await openDB();
Â  return new Promise((res,rej)=>{
Â  Â  const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).getAllKeys();
Â  Â  req.onsuccess = ()=> res(req.result);
Â  Â  req.onerror = ()=> rej(req.error);
Â  });
}
async function idbDelete(id){
Â  const db = await openDB();
Â  return new Promise((res,rej)=>{
Â  Â  const tx = db.transaction(IDB_STORE,'readwrite');
Â  Â  tx.objectStore(IDB_STORE).delete(id);
Â  Â  tx.oncomplete = ()=> res(true);
Â  Â  tx.onerror = ()=> rej(tx.error);
Â  });
}
async function idbClear(){
Â  const db = await openDB();
Â  return new Promise((res,rej)=>{
Â  Â  const tx = db.transaction(IDB_STORE,'readwrite');
Â  Â  tx.objectStore(IDB_STORE).clear();
Â  Â  tx.oncomplete = ()=> res(true);
Â  Â  tx.onerror = ()=> rej(tx.error);
Â  });
}
async function idbCount(){ const keys = await idbGetAllKeys(); return keys.length; }

// ---------- Utilities ----------
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function fmtTime(s){ if(!s && s!==0) return '0:00'; const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; }
function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

// ---------- Load & Save metadata ----------
function saveMeta(){
Â  try{
Â  Â  const payload = {v:1, created:Date.now(), tracks: tracks.map(t=>({ id:t.id, name:t.name, size:t.size, type:t.type, coverBase64:t.coverBase64||null, saved:!!t.saved }))};
Â  Â  localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
Â  }catch(e){ console.warn('saveMeta err', e); }
}
function loadMeta(){
Â  const raw = localStorage.getItem(STORAGE_KEY);
Â  if(!raw) return;
Â  try{
Â  Â  const p = JSON.parse(raw);
Â  Â  if(!p.tracks) return;
Â  Â  tracks = p.tracks.map(x=>({ ...x }));
Â  Â  // queue
Â  Â  queue = tracks.map(t=>t.id);
Â  }catch(e){ console.warn('loadMeta err', e); }
}

// ---------- Render playlist ----------
function renderPlaylist(filter=''){
    playlistEl.innerHTML = '';
    const list = tracks.filter(t=> t.name.toLowerCase().includes(filter.toLowerCase()));
    if(list.length===0){ playlistEl.innerHTML = `<div style="color:var(--muted)">ChÆ°a cÃ³ bÃ i nÃ o â€” thÃªm file Ä‘á»ƒ báº¯t Ä‘áº§u.</div>`; return; }
    const currentTrackId = queue.length > 0 && idx >= 0 ? queue[idx] : null;

    for(const t of list){
        const el = document.createElement('div'); 
        el.className='track';
        if (t.id === currentTrackId) {
            el.classList.add('playing'); // Ãp dá»¥ng hiá»‡u á»©ng Ä‘ang phÃ¡t
        }
        
        const coverEl = document.createElement('div'); coverEl.className='t-cover';
        if(t.coverBase64){ const img = document.createElement('img'); img.src = t.coverBase64; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; coverEl.appendChild(img); }
        else { coverEl.style.background = gradientFromString(t.name); coverEl.textContent = initials(t.name); }

        const info = document.createElement('div'); info.className='t-info';
        const title = document.createElement('div'); title.className='t-title'; title.textContent = t.name;
        const sub = document.createElement('div'); sub.className='t-sub'; 
        sub.textContent = `${Math.round((t.size||0)/1024)} KB ${t.saved? 'Â· Saved' : ''}`;
        info.appendChild(title); info.appendChild(sub);

        const actions = document.createElement('div'); actions.className='t-actions';
        const play = document.createElement('button'); play.className='btn'; play.textContent='â–¶ï¸'; play.onclick = ()=> playById(t.id);
        const attach = document.createElement('button'); attach.className='btn'; attach.textContent='ğŸ“'; attach.title='ThÃªm file (náº¿u chá»‰ lÆ°u metadata)';
        attach.onclick = (e)=> { e.stopPropagation(); attachFileToMeta(t.id); };
        const dl = document.createElement('button'); dl.className='btn'; dl.textContent='ğŸ”—'; dl.onclick = (e)=> { e.stopPropagation(); downloadTrack(t.id); };
        const del = document.createElement('button'); del.className='btn'; del.textContent='ğŸ—‘ï¸'; del.onclick = async (e)=>{
            e.stopPropagation();
            if(!confirm('XÃ³a track nÃ y?')) return;
            await removeTrack(t.id);
        };

        actions.appendChild(play); actions.appendChild(attach); actions.appendChild(dl); actions.appendChild(del);

        el.appendChild(coverEl); el.appendChild(info); el.appendChild(actions);
        el.onclick = ()=> playById(t.id); // Click vÃ o track Ä‘á»ƒ chÆ¡i
        playlistEl.appendChild(el);
    }
}

// ---------- Player functions ----------
function setNowUI(t){
Â  nowTitle.textContent = t ? t.name : 'â€”';
Â  nowMeta.textContent = t ? `${Math.round((t.size||0)/1024)} KB` : 'â€”';
Â  if(t && t.coverBase64){ mainCover.innerHTML = `<img src="${t.coverBase64}" style="width:100%;height:100%;object-fit:cover">`; barCover.innerHTML = `<img src="${t.coverBase64}" style="width:100%;height:100%;object-fit:cover">`; }
Â  else { mainCover.textContent = t ? initials(t.name) : 'ğŸµ'; mainCover.style.background = t ? gradientFromString(t.name) : ''; barCover.textContent = t ? initials(t.name) : 'ğŸµ'; barCover.style.background = t ? gradientFromString(t.name) : ''; }
Â  if(t){ playerBar.style.display = 'flex'; barTitle.textContent = t.name; barSub.textContent = `${Math.round((t.size||0)/1024)} KB`; } else { playerBar.style.display='none'; }
    renderPlaylist(searchInput.value); // Cáº­p nháº­t tráº¡ng thÃ¡i 'playing' trong playlist
}

function playById(id){
Â  const t = tracks.find(x=>x.id===id); if(!t) return;
Â  idx = queue.indexOf(id);
Â  // check runtime file
Â  const rf = runtimeFiles.get(id);
Â  if(rf){
Â  Â  audio.src = rf.url;
Â  Â  audio.play().catch(()=>{});
Â  Â  setNowUI(t);
Â  Â  playBtn.textContent = 'â¸'; barPlay.textContent='â¸';
Â  Â  return;
Â  }
Â  // if saved in IDB, get blob
Â  if(t.saved){
Â  Â  idbGet(id).then(rec=>{
Â  Â  Â  if(rec && rec.blob){
Â  Â  Â  Â  const url = URL.createObjectURL(rec.blob);
Â  Â  Â  Â  runtimeFiles.set(id,{file:rec.blob,url});
Â  Â  Â  Â  audio.src = url; audio.play().catch(()=>{});
Â  Â  Â  Â  setNowUI(t);
Â  Â  Â  Â  playBtn.textContent='â¸'; barPlay.textContent='â¸';
Â  Â  Â  } else {
Â  Â  Â  Â  alert('KhÃ´ng tÃ¬m tháº¥y file lÆ°u. Vui lÃ²ng import láº¡i hoáº·c lÆ°u file offline.');
Â  Â  Â  }
Â  Â  }).catch(err=>{ console.error(err); alert('Lá»—i Ä‘á»c IDB'); });
Â  Â  return;
Â  }
Â  alert('Track chá»‰ lÆ°u metadata. HÃ£y báº¥m ğŸ“ Ä‘á»ƒ thÃªm file tÆ°Æ¡ng á»©ng (chá»‰ cáº§n 1 láº§n).');
}

// prev / next
function playNext(){ if(idx < queue.length-1){ idx++; playById(queue[idx]); } else if(repeatMode==='all'){ idx=0; playById(queue[idx]); } else { audio.pause(); playBtn.textContent='â–¶ï¸'; barPlay.textContent='â–¶ï¸'; setNowUI(tracks.find(t=>t.id===queue[idx])); } }
function playPrev(){ if(idx>0){ idx--; playById(queue[idx]); } }

// audio events
audio.addEventListener('timeupdate', ()=>{
Â  if(audio.duration){ const pct = (audio.currentTime/audio.duration)*100; seek.value = pct; barSeek.value = pct; timeLabel.textContent = `${fmtTime(audio.currentTime)} / ${fmtTime(audio.duration)}`; barTime.textContent = timeLabel.textContent; }
});
seek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; });
barSeek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; });

audio.addEventListener('play', ()=>{ playBtn.textContent = 'â¸'; barPlay.textContent='â¸'; renderPlaylist(searchInput.value); });
audio.addEventListener('pause', ()=>{ playBtn.textContent = 'â–¶ï¸'; barPlay.textContent='â–¶ï¸'; });

audio.addEventListener('ended', ()=>{ if(repeatMode==='one'){ audio.currentTime=0; audio.play(); } else playNext(); });

// play/pause
playBtn.addEventListener('click', ()=>{ if(!audio.src){ if(queue.length) playById(queue[0]); return; } if(audio.paused){ audio.play(); } else { audio.pause(); } });
barPlay.addEventListener('click', ()=>{ playBtn.click(); });
prevBtn.addEventListener('click', playPrev); barPrev.addEventListener('click', playPrev);
nextBtn.addEventListener('click', playNext); barNext.addEventListener('click', playNext);

// shuffle / repeat
shuffleBtn.addEventListener('click', ()=>{ shuffleMode = !shuffleMode; queue = shuffleMode ? shuffleArray(tracks.map(t=>t.id)) : tracks.map(t=>t.id); shuffleBtn.textContent = shuffleMode ? 'ğŸ”€ ON' : 'ğŸ”€ Shuffle'; });
repeatBtn.addEventListener('click', ()=>{ repeatMode = repeatMode==='off'?'one':(repeatMode==='one'?'all':'off'); repeatBtn.textContent = `ğŸ” Repeat: ${repeatMode.charAt(0).toUpperCase() + repeatMode.slice(1)}`; });

// ---------- Attach file to metadata (ğŸ“) ----------
function attachFileToMeta(id){
Â  const fi = document.createElement('input'); fi.type='file'; fi.accept='audio/*';
Â  fi.onchange = async e=>{
Â  Â  const f = e.target.files[0]; if(!f) return;
Â  Â  // revoke old
Â  Â  if(runtimeFiles.has(id)){ const old = runtimeFiles.get(id); try{ URL.revokeObjectURL(old.url);}catch(e){} }
Â  Â  const url = URL.createObjectURL(f);
Â  Â  runtimeFiles.set(id,{file:f,url});
Â  Â  // if saveFilesOffline on, store to IDB automatically
Â  Â  if(saveFilesOffline){ await idbPut(id, f, {name:f.name,type:f.type,size:f.size}); const t = tracks.find(x=>x.id===id); if(t){ t.saved = true; saveMeta(); updateStorageUI(); } }
Â  Â  renderPlaylist(searchInput.value);
Â  Â  alert('File Ä‘Ã£ gáº¯n vá»›i metadata (táº¡m thá»i). Reload trang sáº½ máº¥t file nÃ y trá»« khi báº¡n Export/Save offline.');
Â  };
Â  fi.click();
}

// ---------- Download individual track (if runtime exists or saved) ----------
async function downloadTrack(id){
Â  const rf = runtimeFiles.get(id);
Â  if(rf && rf.url){
Â  Â  const a = document.createElement('a'); a.href = rf.url; a.download = tracks.find(t=>t.id===id).name; a.click(); return;
Â  }
Â  // else from IDB
Â  const rec = await idbGet(id);
Â  if(rec && rec.blob){
Â  Â  const url = URL.createObjectURL(rec.blob);
Â  Â  const a = document.createElement('a'); a.href = url; a.download = tracks.find(t=>t.id===id).name; a.click(); URL.revokeObjectURL(url);
Â  Â  return;
Â  }
Â  alert('KhÃ´ng cÃ³ file Ä‘á»ƒ táº£i. HÃ£y thÃªm file (ğŸ“) hoáº·c Export playlist Ä‘áº§y Ä‘á»§.');
}

// ---------- Remove track ----------
async function removeTrack(id){
Â  // remove runtime url
Â  if(runtimeFiles.has(id)){ const r = runtimeFiles.get(id); try{ URL.revokeObjectURL(r.url);}catch(e){} runtimeFiles.delete(id); }
Â  // remove saved IDB
Â  try{ await idbDelete(id); }catch(e){}
Â  tracks = tracks.filter(t=>t.id!==id);
Â  queue = tracks.map(t=>t.id);
Â  if(idx>=tracks.length) idx = tracks.length-1;
Â  saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
}

// ---------- Add files (input / drop) ----------
fileInput.addEventListener('change', async e=>{ if(e.target.files.length) await handleFiles(e.target.files); fileInput.value=''; });
async function handleFiles(fileList){
Â  for(const f of Array.from(fileList)){
Â  Â  const id = uid();
Â  Â  const tmeta = { id, name: f.name, size: f.size, type: f.type, coverBase64: null, saved: false };
Â  Â  // try read ID3 cover if jsmediatags present
Â  Â  if(window.jsmediatags){
Â  Â  Â  try{
Â  Â  Â  Â  await new Promise((res,rej)=>{
Â  Â  Â  Â  Â  jsmediatags.read(f, {
Â  Â  Â  Â  Â  Â  onSuccess: tag => {
Â  Â  Â  Â  Â  Â  Â  const picture = tag.tags.picture;
Â  Â  Â  Â  Â  Â  Â  if(picture){
Â  Â  Â  Â  Â  Â  Â  Â  const base64 = arrayBufferToBase64(picture.data);
Â  Â  Â  Â  Â  Â  Â  Â  const mime = picture.format || 'image/jpeg';
Â  Â  Â  Â  Â  Â  Â  Â  tmeta.coverBase64 = `data:${mime};base64,${base64}`;
Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  res();
Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  onError: ()=> res()
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  Â  }catch(e){}
Â  Â  }
Â  Â  tracks.push(tmeta);
Â  Â  // runtime file url
Â  Â  const url = URL.createObjectURL(f);
Â  Â  runtimeFiles.set(id,{file:f,url});
Â  Â  // if user enabled saveFilesOffline, write to IDB immediately
Â  Â  if(saveFilesOffline){ try{ await idbPut(id,f,{name:f.name,type:f.type,size:f.size}); tmeta.saved = true; }catch(e){ console.warn('idb put err', e); } }
Â  }
Â  queue = tracks.map(t=>t.id);
Â  saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
}

// cover input (global cover for new items)
coverInput.addEventListener('change', async e=>{
Â  const f = e.target.files[0]; if(!f) return;
Â  const reader = new FileReader();
Â  reader.onload = ()=> {
Â  Â  const base = reader.result;
Â  Â  // set cover for last added track(s) â€” apply to tracks that don't have cover
Â  Â  for(let i=tracks.length-1;i>=0;i--){
Â  Â  Â  if(!tracks[i].coverBase64){ tracks[i].coverBase64 = base; break; }
Â  Â  }
Â  Â  saveMeta(); renderPlaylist(searchInput.value);
Â  };
Â  reader.readAsDataURL(f);
Â  coverInput.value='';
});

// drag & drop support
document.addEventListener('dragover', e=>e.preventDefault());
document.addEventListener('drop', async e=>{ e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) await handleFiles(e.dataTransfer.files); });

// ---------- Export / Import ----------
exportBtn.addEventListener('click', async ()=>{
Â  if(tracks.length===0){ alert('KhÃ´ng cÃ³ track Ä‘á»ƒ export'); return; }
Â  if(!confirm('Export sáº½ táº¡o file JSON cÃ³ thá»ƒ lá»›n (bao gá»“m base64 cá»§a file Ä‘Ã£ lÆ°u trong IDB hoáº·c runtime). Báº¡n cháº¯c?')) return;
Â  const payload = {created:Date.now(), version:2, tracks:[]};
Â  for(const t of tracks){
Â  Â  const rec = { name: t.name, size: t.size, type: t.type, cover: t.coverBase64 || null, base: null };
Â  Â  // prefer IDB saved
Â  Â  if(t.saved){
Â  Â  Â  const stored = await idbGet(t.id);
Â  Â  Â  if(stored && stored.blob){ rec.base = await blobToBase64(stored.blob); }
Â  Â  } else {
Â  Â  Â  const rf = runtimeFiles.get(t.id);
Â  Â  Â  if(rf && rf.file){ rec.base = await blobToBase64(rf.file); }
Â  Â  }
Â  Â  payload.tracks.push(rec);
Â  }
Â  const blob = new Blob([JSON.stringify(payload)],{type:'application/json'});
Â  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `yuung_export_${new Date().toISOString().slice(0,10)}.yuung.json`; a.click();
});

importBtn.addEventListener('click', ()=>{
Â  const fi = document.createElement('input'); fi.type='file'; fi.accept='.json,application/json';
Â  fi.onchange = async e=>{
Â  Â  const f = e.target.files[0]; if(!f) return;
Â  Â  try{
Â  Â  Â  const txt = await f.text(); const p = JSON.parse(txt); if(!p.tracks) throw 'invalid';
Â  Â  Â  for(const item of p.tracks){
Â  Â  Â  Â  const id = uid();
Â  Â  Â  Â  const md = { id, name: item.name, size: item.size||0, type: item.type||'audio/mpeg', coverBase64: item.cover||null, saved:false };
Â  Â  Â  Â  tracks.push(md);
Â  Â  Â  Â  if(item.base){
Â  Â  Â  Â  Â  const blob = base64ToBlob(item.base, item.type||'audio/mpeg');
Â  Â  Â  Â  Â  const file = new File([blob], item.name, {type:item.type});
Â  Â  Â  Â  Â  const url = URL.createObjectURL(file);
Â  Â  Â  Â  Â  runtimeFiles.set(id,{file,url});
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  queue = tracks.map(t=>t.id);
Â  Â  Â  saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
Â  Â  Â  alert('Import xong!');
Â  Â  }catch(err){ console.error(err); alert('Import lá»—i'); }
Â  };
Â  fi.click();
});

// ---------- Save all / remove saved ----------
saveAllBtn.addEventListener('click', async ()=>{
Â  if(tracks.length===0){ alert('No tracks'); return; }
Â  if(!confirm('LÆ°u táº¥t cáº£ file runtime vÃ o IndexedDB (tá»‘n dung lÆ°á»£ng). Tiáº¿p tá»¥c?')) return;
Â  for(const t of tracks){
Â  Â  try{
Â  Â  Â  let blob = null;
Â  Â  Â  if(runtimeFiles.has(t.id)){ blob = runtimeFiles.get(t.id).file; }
Â  Â  Â  else {
Â  Â  Â  Â  const rec = await idbGet(t.id);
Â  Â  Â  Â  if(rec && rec.blob) blob = rec.blob;
Â  Â  Â  }
Â  Â  Â  if(blob){ await idbPut(t.id, blob, {name:t.name,type:t.type,size:t.size}); t.saved = true; }
Â  Â  }catch(e){ console.warn('saveAll err', e); }
Â  }
Â  saveMeta(); updateStorageUI(); alert('Save all finished');
});

removeAllSavedBtn.addEventListener('click', async ()=>{
Â  if(!confirm('XÃ³a táº¥t cáº£ file Ä‘Ã£ lÆ°u trong IndexedDB?')) return;
Â  await idbClear();
Â  for(const t of tracks) t.saved = false;
Â  saveMeta(); updateStorageUI();
Â  alert('ÄÃ£ xÃ³a');
});

// ---------- Download all (zip) ----------
downloadAllBtn.addEventListener('click', async ()=>{
Â  // collect blobs
Â  const files = [];
Â  for(const t of tracks){
Â  Â  if(runtimeFiles.has(t.id)) files.push({name:t.name,file:runtimeFiles.get(t.id).file});
Â  Â  else {
Â  Â  Â  const rec = await idbGet(t.id);
Â  Â  Â  if(rec && rec.blob) files.push({name:t.name,file:rec.blob});
Â  Â  }
Â  }
Â  if(files.length===0){ alert('KhÃ´ng cÃ³ file thá»±c táº¿ Ä‘á»ƒ táº£i. HÃ£y gáº¯n file hoáº·c lÆ°u offline.'); return; }
Â  if(window.JSZip){
Â  Â  const zip = new JSZip();
Â  Â  files.forEach(f=> zip.file(f.name, f.file));
Â  Â  const content = await zip.generateAsync({type:'blob'});
Â  Â  const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = 'yuung_tracks.zip'; a.click();
Â  } else {
Â  Â  if(!confirm('JSZip chÆ°a Ä‘Æ°á»£c táº£i. Sáº½ táº£i tá»«ng file má»™t. OK?')) return;
Â  Â  for(const f of files){
Â  Â  Â  const url = URL.createObjectURL(f.file);
Â  Â  Â  const a = document.createElement('a'); a.href = url; a.download = f.name; a.click();
Â  Â  Â  URL.revokeObjectURL(url);
Â  Â  }
Â  }
});

// ---------- Remove all tracks ----------
clearBtn.addEventListener('click', async ()=>{
Â  if(!confirm('XÃ³a toÃ n bá»™ playlist?')) return;
Â  runtimeFiles.forEach(r=>{ try{ URL.revokeObjectURL(r.url);}catch(e){} });
Â  runtimeFiles.clear();
Â  tracks=[]; queue=[]; idx=-1;
Â  await idbClear();
Â  saveMeta(); renderPlaylist(); setNowUI(null); updateStorageUI();
});

// ---------- UI helpers ----------
function initials(name){ return name.replace(/\.\w+$/,'').split(/[\s-_]+/).slice(0,2).map(s=>s[0]).join('').toUpperCase() || 'â™ª'; }
function gradientFromString(s){ let h=0; for(let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5)-h); const a = `hsl(${Math.abs(h)%360} 70% 45%)`, b = `hsl(${(Math.abs(h)+60)%360} 70% 60%)`; return `linear-gradient(135deg, ${a}, ${b})`;}
function shuffleArray(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function arrayBufferToBase64(buffer){ let binary=''; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary); }
function blobToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=> res(r.result.split(',')[1]); r.onerror=()=> rej(r.error); r.readAsDataURL(file); }); }
function base64ToBlob(b64, type){ const bin = atob(b64); let len = bin.length; const u8 = new Uint8Array(len); for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i); return new Blob([u8],{type:type||'application/octet-stream'}); }

// ---------- Storage UI Update (Placeholder - You need to implement the actual storage calculation) ----------
function updateStorageUI() {
    idbCount().then(count => {
        idbUsage.textContent = `IDB: ${count} files`;
        storageStatus.textContent = `Offline files: ${tracks.filter(t => t.saved).length}`;
    });
    // Cáº­p nháº­t nÃºt Save offline:
    if (saveFilesOffline) {
        toggleSaveFiles.textContent = 'ğŸ’¾ Save offline: ON';
        toggleSaveFiles.classList.add('primary');
        toggleSaveFiles.classList.remove('ghost');
    } else {
        toggleSaveFiles.textContent = 'ğŸ’¾ Save offline: Off';
        toggleSaveFiles.classList.remove('primary');
        toggleSaveFiles.classList.add('ghost');
    }
}
toggleSaveFiles.addEventListener('click', () => {
    saveFilesOffline = !saveFilesOffline;
    localStorage.setItem('saveFilesOffline', saveFilesOffline ? '1' : '0');
    updateStorageUI();
});
saveFilesOffline = localStorage.getItem('saveFilesOffline') === '1';

// ---------- Attach event: search ----------
searchInput.addEventListener('input', ()=> renderPlaylist(searchInput.value));

// ---------- Init ----------
loadMeta();
updateStorageUI();
renderPlaylist();
setNowUI(null);

})(); // End IIFE
</script>
</body>
</html>
