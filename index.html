<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Yuung Playlist ‚Äî Full (Offline, PWA, IndexedDB)</title>
<meta name="theme-color" content="#0b7fa8" id="metaThemeColor">

<script src="https://unpkg.com/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
    /* ============================
    DARK MODE ‚Äì CH·ªÆ TR·∫ÆNG FULL
    ============================ */
    .dark-mode {
        --bg-color: #0e0e0e;
        --text-color: #ffffff;
    }

    .dark-mode body,
    .dark-mode * {
        color: var(--text-color) !important;
    }

    /* N·ªÅn container + card */
    .dark-mode .container,
    .dark-mode .music-item,
    .dark-mode .music-card,
    .dark-mode .playlist {
        background: #1a1a1a !important;
        border-color: rgba(255,255,255,0.2) !important;
    }

    /* Ti√™u ƒë·ªÅ */
    .dark-mode h1,
    .dark-mode h2,
    .dark-mode h3 {
        color: #fff !important;
    }

    /* Input + button */
    .dark-mode input,
    .dark-mode button {
        background: #2a2a2a !important;
        color: #fff !important;
        border-color: rgba(255,255,255,0.2) !important;
    }

    /* Player */
    .dark-mode .player-controls,
    .dark-mode #title {
        color: #fff !important;
    }

    /* Thanh seek trong dark mode */
    .dark-mode input[type=range] {
        background: rgba(255,255,255,0.2);
    }
    .dark-mode input[type=range]::-webkit-slider-thumb {
        background: var(--accent);
    }

    /* ============================
      THEME & LAYOUT
      ============================ */
    :root{
      --bg1: #f0fbff;
      --bg2: #e6f9ff;
      --card: #ffffff;
      --muted: #6b8b92;
      --text: #043242;
      --accent: #ff4757; /* ƒê·ªè */
      --accent2: #00a6ff; /* Xanh d∆∞∆°ng */
      --glass: rgba(255,255,255,0.6);
      --radius: 16px;
      --shadow: 0 4px 10px rgba(3,50,64,0.08), 0 10px 30px rgba(3,50,64,0.04); /* C·∫£i ti·∫øn b√≥ng ƒë·ªï */
    }
    [data-theme="dark"]{
      --bg1: #03181d;
      --bg2: #07262e;
      --card: #071722;
      --muted: #9fdff5;
      --text: #dff8ff;
      --accent: #ff6b87;
      --accent2: #06b3ff;
      --glass: rgba(255,255,255,0.02);
      --shadow: 0 10px 30px rgba(0,0,0,0.5);
    }

    html,body{height:100%;margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue";background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
    .wrap{max-width:1100px;margin:20px auto;padding:18px}
    header{display:flex;align-items:center;gap:14px;padding:14px;border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow)}
    .logo{width:64px;height:64px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-size:28px;font-weight:800}
    h1{margin:0;font-size:20px}
    .subtitle{font-size:13px;color:var(--muted)}

    /* controls */
    .controls{display:flex;flex-wrap:wrap;gap:10px;margin-top:12px}
    .btn{background:var(--card);border:0;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);font-size:14px}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700}
    .btn.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}

    /* Hi·ªáu ·ª©ng t∆∞∆°ng t√°c */
    .btn, .file-btn, .track{transition:all .2s ease}
    .btn:hover:not(.primary), .file-btn:hover, .track:hover{transform:translateY(-2px); box-shadow: 0 6px 15px rgba(3,50,64,0.1); background: var(--bg2);}
    .btn:active, .file-btn:active{transform:scale(0.98); opacity:0.9;}
    .btn.primary:hover{transform:translateY(-2px); box-shadow: 0 6px 15px rgba(255,71,87,0.3);}


    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
    @media (max-width:900px){ .grid{grid-template-columns:1fr; } }

    /* left column: player + add */
    .card{background:var(--card);border-radius:14px;padding:14px;box-shadow:var(--shadow)}
    .cover{
        width:100%;height:320px;border-radius:12px;
        background:linear-gradient(135deg,#ddd,#bbb);
        display:flex;align-items:center;justify-content:center;
        font-size:42px;color:white;font-weight:800;overflow:hidden;
        /* C·∫£i ti·∫øn Cover */
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        border: 4px solid var(--bg1);
    }
    .meta{margin-top:12px}
    .meta h2{margin:0;font-size:18px}
    .meta .small{font-size:13px;color:var(--muted);margin-top:6px}

    .file-controls{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    label.file-btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:12px;background:var(--card);cursor:pointer;border:1px dashed rgba(0,0,0,0.06)}
    input[type=file]{display:none}

    /* save offline toggle and storage status */
    .row{display:flex;align-items:center;gap:10px}
    .toggle{padding:8px 12px;border-radius:12px;background:var(--card);cursor:pointer;box-shadow:var(--shadow)}
    .status{font-size:13px;color:var(--muted)}

    /* right column: playlist */
    .playlist{display:flex;flex-direction:column;gap:10px}
    .search-row{display:flex;gap:8px;align-items:center}
    .search{flex:1;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);background:transparent}
    .track{display:flex;align-items:center;gap:12px;padding:10px;border-radius:12px;background:var(--card);box-shadow:var(--shadow)}
    .track .t-cover{width:64px;height:64px;border-radius:10px;overflow:hidden;background:linear-gradient(135deg,#ddd,#ccc);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff}
    .track .t-info{flex:1;min-width:0}
    .t-title{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .t-sub{font-size:12px;color:var(--muted);margin-top:6px}

    .track .t-actions{display:flex;gap:6px}
    .track .t-actions .btn {
        width: 38px;
        height: 38px;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    /* N·ªïi b·∫≠t n√∫t Play trong danh s√°ch */
    .track .t-actions .btn-play-track {
        background: var(--accent2);
        color: white;
        font-weight: 700;
    }

    /* T·∫°o ki·ªÉu cho thanh Seek (Range Input) */
    input[type=range] {
        -webkit-appearance: none;
        width: 100%;
        height: 8px;
        background: rgba(0,0,0,0.1);
        border-radius: 4px;
        cursor: pointer;
        transition: background .2s ease;
    }
    input[type=range]:focus {
        outline: none;
    }
    input[type=range]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: 16px;
        height: 16px;
        background: var(--accent);
        border-radius: 50%;
        box-shadow: 0 0 4px rgba(0,0,0,0.4);
        transition: background .2s ease;
    }

    /* bottom player sticky */
    .player-bar{position:fixed;left:50%;transform:translateX(-50%);bottom:18px;width:calc(100% - 60px);max-width:1100px;background:var(--card);padding:12px;border-radius:16px;box-shadow:0 14px 40px rgba(3,50,64,0.12);display:flex;align-items:center;gap:12px}
    .player-cover{width:60px;height:60px;border-radius:10px;overflow:hidden}
    .player-controls{display:flex;align-items:center;gap:8px}
    .seek{flex:1}
    .time{min-width:110px;text-align:right;font-size:13px;color:var(--muted)}

    /* small screens */
    @media (max-width:520px){
      .cover{height:220px}
      .player-bar{width:calc(100% - 28px);padding:10px}
      .player-cover{width:48px;height:48px}
      /* ·∫®n seek bar v√† th·ªùi gian ·ªü thanh d∆∞·ªõi tr√™n m√†n h√¨nh nh·ªè */
      #barSeek, #barTime { display: none !important; }
      .player-bar { justify-content: space-between; }
    }

</style>
</head>
<body>

<div class="wrap">
  <header>
    <div class="logo">üéß</div>
    <div style="flex:1">
      <h1>Yuung Playlist</h1>
      <div class="subtitle">Offline-ready ¬∑ PWA ¬∑ Dark mode ¬∑ Thumbnails ¬∑ IndexedDB save</div>
    </div>
    <div style="display:flex;gap:8px">
      <button id="themeToggle" class="btn">üåô</button>
      <button id="installBtn" class="btn">üì≤ C√†i ƒë·∫∑t</button>
    </div>
  </header>

  <div class="controls" style="margin-top:14px">
    <label class="file-btn" id="addFilesBtn">‚ûï Th√™m file nh·∫°c
      <input id="fileInput" type="file" accept="audio/*" multiple />
    </label>

    <label class="file-btn" id="addCoverBtn">üñºÔ∏è Th√™m cover chung
      <input id="coverInput" type="file" accept="image/*" />
    </label>

    <div class="row" style="margin-left:auto;gap:8px">
      <div class="status" id="storageStatus">File ngo·∫°i tuy·∫øn: 0</div>
      <button id="toggleSaveFiles" class="btn">üíæ T·ª± ƒë·ªông l∆∞u: T·∫Øt</button>
    </div>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="cover" id="mainCover">üéµ</div>

        <div class="meta">
          <h2 id="nowTitle">‚Äî</h2>
          <div class="small" id="nowMeta">Ch∆∞a ch∆°i b√†i n√†o</div>
        </div>

        <div style="margin-top:12px">
          <div style="display:flex;gap:8px;align-items:center">
            <button id="prev" class="btn">‚èÆ B√†i tr∆∞·ªõc</button>
            <button id="play" class="btn primary">‚ñ∂Ô∏è Play</button>
            <button id="next" class="btn">‚è≠ B√†i sau</button>

            <div style="flex:1;margin-left:8px">
              <input id="seek" type="range" min="0" max="100" value="0" class="seek" style="width:100%">
            </div>

            <div class="time" id="timeLabel">0:00 / 0:00</div>
          </div>

          <div style="display:flex;gap:8px;margin-top:10px;flex-wrap:wrap">
            <button id="shuffleBtn" class="btn">üîÄ Shuffle</button>
            <button id="repeatBtn" class="btn">üîÅ L·∫∑p: T·∫Øt</button>
            <button id="exportBtn" class="btn">üì§ Export</button>
            <button id="importBtn" class="btn">üì• Import</button>
            <button id="clearBtn" class="btn">üóëÔ∏è X√≥a h·∫øt</button>
          </div>
        </div>
      </div>

      <div style="margin-top:12px" class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <strong>Qu·∫£n l√Ω Storage</strong>
            <div class="small">B·∫°n c√≥ th·ªÉ l∆∞u file v√†o b·ªô nh·ªõ tr√¨nh duy·ªát ƒë·ªÉ ph√°t offline.</div>
          </div>
          <div style="text-align:right">
            <div id="idbUsage" class="small-muted">IDB: 0 files</div>
            <div class="small-muted" id="quotaInfo"></div>
          </div>
        </div>

        <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
          <button id="saveAllBtn" class="btn">üíæ L∆∞u t·∫•t c·∫£</button>
          <button id="removeAllSavedBtn" class="btn">üßπ X√≥a file ƒë√£ l∆∞u</button>
        </div>
      </div>
    </div>

    <div>
      <div class="card">
        <div class="search-row">
          <input id="search" class="search" placeholder="T√¨m trong playlist..." />
          <button id="downloadAll" class="btn">‚¨áÔ∏è T·∫£i t·∫•t c·∫£</button>
        </div>

        <div id="playlist" style="margin-top:12px" class="playlist"></div>
      </div>
    </div>
  </div>
</div>

<div class="player-bar" id="playerBar" style="display:none">
  <div class="player-cover" id="barCover">üéµ</div>
  <div style="flex:1">
    <div id="barTitle" style="font-weight:700">‚Äî</div>
    <div id="barSub" class="small-muted">‚Äî</div>
  </div>
  <div class="player-controls">
    <button id="barPrev" class="btn">‚èÆ</button>
    <button id="barPlay" class="btn primary">‚ñ∂Ô∏è</button>
    <button id="barNext" class="btn">‚è≠</button>
  </div>
  <div style="width:220px;margin-left:12px">
    <input id="barSeek" type="range" min="0" max="100" value="0" style="width:100%">
  </div>
  <div class="time" id="barTime">0:00 / 0:00</div>
</div>

<script>
// ---------- DARK MODE & THEME TOGGLE ----------
function toggleDarkMode() {
    const isDark = document.documentElement.classList.toggle("dark-mode");
    localStorage.setItem("darkMode", isDark ? "1" : "0");
    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
    document.getElementById('metaThemeColor').setAttribute('content', isDark ? '#1a1a1a' : '#0b7fa8');
}
// T·ª± b·∫≠t dark mode n·∫øu l·∫ßn tr∆∞·ªõc b·∫≠t
if (localStorage.getItem("darkMode") === "1") {
    document.documentElement.classList.add("dark-mode");
    document.documentElement.setAttribute('data-theme', 'dark');
} else {
    document.documentElement.setAttribute('data-theme', 'light');
}
themeToggle.addEventListener('click', toggleDarkMode);

/* ===================================================
  FULL APP SCRIPT (ƒê√£ tinh ch·ªânh)
  =================================================== */

(async()=>{ // IIFE to keep scope

// ---------- State ----------
const STORAGE_KEY = 'yuung_meta_v3';
let tracks = []; // {id,name,size,type,coverBase64, saved:bool}
let runtimeFiles = new Map(); // id -> {file:File, url:objectURL}
let queue = [], idx = -1;
let shuffleMode = false, repeatMode = 'off';
let saveFilesOffline = localStorage.getItem('saveFilesOffline') === '1'; // Load state

// ---------- DOM Refs (ƒê√£ ƒë·ªãnh nghƒ©a ·ªü tr√™n) ----------
// ... (C√°c ƒë·ªãnh nghƒ©a DOM refs ƒë√£ c√≥) ...

// audio
const audio = new Audio();
audio.setAttribute('playsinline','');

// ---------- IndexedDB helpers (Kh√¥ng thay ƒë·ªïi) ----------
const IDB_DB = 'yuung_db_v1', IDB_STORE = 'files';

function openDB(){ return new Promise((res,rej)=>{
  const r = indexedDB.open(IDB_DB,1);
  r.onupgradeneeded = ()=> {
    const db = r.result;
    if(!db.objectStoreNames.contains(IDB_STORE)) db.createObjectStore(IDB_STORE, {keyPath:'id'});
  };
  r.onsuccess = ()=> res(r.result);
  r.onerror = ()=> rej(r.error);
});}

async function idbPut(id, blob, meta){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).put({id,blob,meta});
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function idbGet(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const r = db.transaction(IDB_STORE).objectStore(IDB_STORE).get(id);
    r.onsuccess = ()=> res(r.result);
    r.onerror = ()=> rej(r.error);
  });
}
async function idbGetAllKeys(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const req = db.transaction(IDB_STORE).objectStore(IDB_STORE).getAllKeys();
    req.onsuccess = ()=> res(req.result);
    req.onerror = ()=> rej(req.error);
  });
}
async function idbDelete(id){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).delete(id);
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function idbClear(){
  const db = await openDB();
  return new Promise((res,rej)=>{
    const tx = db.transaction(IDB_STORE,'readwrite');
    tx.objectStore(IDB_STORE).clear();
    tx.oncomplete = ()=> res(true);
    tx.onerror = ()=> rej(tx.error);
  });
}
async function idbCount(){ const keys = await idbGetAllKeys(); return keys.length; }

// ---------- Utilities ----------
function uid(){ return Date.now().toString(36) + Math.random().toString(36).slice(2,8); }
function fmtTime(s){ if(!s && s!==0) return '0:00'; const m = Math.floor(s/60); const sec = Math.floor(s%60); return `${m}:${sec.toString().padStart(2,'0')}`; }
function escapeHtml(s){ return s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }
function initials(name){ return name.replace(/\.\w+$/,'').split(/[\s-_]+/).slice(0,2).map(s=>s[0]).join('').toUpperCase() || '‚ô™'; }
function gradientFromString(s){ let h=0; for(let i=0;i<s.length;i++) h = s.charCodeAt(i) + ((h<<5)-h); const a = `hsl(${Math.abs(h)%360} 70% 45%)`, b = `hsl(${(Math.abs(h)+60)%360} 70% 60%)`; return `linear-gradient(135deg, ${a}, ${b})`;}
function shuffleArray(a){ const arr=[...a]; for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]];} return arr; }
function arrayBufferToBase64(buffer){ let binary=''; const bytes=new Uint8Array(buffer); for(let i=0;i<bytes.byteLength;i++) binary+=String.fromCharCode(bytes[i]); return btoa(binary); }
function blobToBase64(file){ return new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=> res(r.result.split(',')[1]); r.onerror=()=> rej(r.error); r.readAsDataURL(file); }); }
function base64ToBlob(b64, type){ const bin = atob(b64); let len = bin.length; const u8 = new Uint8Array(len); for(let i=0;i<len;i++) u8[i]=bin.charCodeAt(i); return new Blob([u8],{type:type||'application/octet-stream'}); }

// ---------- Load & Save metadata ----------
function saveMeta(){
  try{
    const payload = {v:1, created:Date.now(), tracks: tracks.map(t=>({ id:t.id, name:t.name, size:t.size, type:t.type, coverBase64:t.coverBase64||null, saved:!!t.saved }))};
    localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
  }catch(e){ console.warn('saveMeta err', e); }
}
function loadMeta(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return;
  try{
    const p = JSON.parse(raw);
    if(!p.tracks) return;
    tracks = p.tracks.map(x=>({ ...x }));
    queue = tracks.map(t=>t.id);
  }catch(e){ console.warn('loadMeta err', e); }
}

// ---------- UI Update & Storage Status ----------
function updateStorageUI(){
    const savedCount = tracks.filter(t=>t.saved).length;
    storageStatus.textContent = `File ngo·∫°i tuy·∫øn: ${savedCount}`;
    idbUsage.textContent = `IDB: ${savedCount} files`;

    toggleSaveFiles.textContent = saveFilesOffline ? 'üíæ T·ª± ƒë·ªông l∆∞u: B·∫≠t' : 'üíæ T·ª± ƒë·ªông l∆∞u: T·∫Øt';

    // Update repeat button text
    if (repeatMode === 'off') repeatBtn.textContent = 'üîÅ L·∫∑p: T·∫Øt';
    else if (repeatMode === 'one') repeatBtn.textContent = 'üîÇ L·∫∑p: 1 b√†i';
    else if (repeatMode === 'all') repeatBtn.textContent = 'üîÅ L·∫∑p: Playlist';
}

// ---------- Render playlist ----------
function renderPlaylist(filter=''){
  playlistEl.innerHTML = '';
  const list = tracks.filter(t=> t.name.toLowerCase().includes(filter.toLowerCase()));
  if(list.length===0){ playlistEl.innerHTML = `<div style="color:var(--muted)">Ch∆∞a c√≥ b√†i n√†o ‚Äî th√™m file ƒë·ªÉ b·∫Øt ƒë·∫ßu.</div>`; return; }
  for(const t of list){
    const el = document.createElement('div'); el.className='track';
    const coverEl = document.createElement('div'); coverEl.className='t-cover';
    if(t.coverBase64){ const img = document.createElement('img'); img.src = t.coverBase64; img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; coverEl.appendChild(img); }
    else { coverEl.style.background = gradientFromString(t.name); coverEl.textContent = initials(t.name); }

    const info = document.createElement('div'); info.className='t-info';
    const title = document.createElement('div'); title.className='t-title'; title.textContent = t.name;
    const sub = document.createElement('div'); sub.className='t-sub';
    sub.innerHTML = `${Math.round((t.size||0)/1024)} KB ${t.saved? '¬∑ üíæ ƒê√£ l∆∞u' : ''}`;
    info.appendChild(title); info.appendChild(sub);

    const actions = document.createElement('div'); actions.className='t-actions';
    const play = document.createElement('button'); play.className='btn btn-play-track'; play.textContent='‚ñ∂Ô∏è'; play.title='Ph√°t'; play.onclick = ()=> playById(t.id);
    const attach = document.createElement('button'); attach.className='btn'; attach.textContent='üìé'; attach.title='G·∫Øn file t·∫°m th·ªùi';
    attach.onclick = ()=> attachFileToMeta(t.id);
    const del = document.createElement('button'); del.className='btn'; del.textContent='üóëÔ∏è'; del.title='X√≥a'; del.onclick = async ()=>{
      if(!confirm(`X√≥a track "${t.name}"?`)) return;
      await removeTrack(t.id);
    };

    actions.appendChild(play); actions.appendChild(attach); actions.appendChild(del);

    el.appendChild(coverEl); el.appendChild(info); el.appendChild(actions);
    playlistEl.appendChild(el);
  }
}

// ---------- Player functions ----------
function setNowUI(t){
  nowTitle.textContent = t ? t.name : '‚Äî';
  nowMeta.textContent = t ? `${Math.round((t.size||0)/1024)} KB` : '‚Äî';
  if(t && t.coverBase64){ mainCover.innerHTML = `<img src="${t.coverBase64}" style="width:100%;height:100%;object-fit:cover">`; barCover.innerHTML = `<img src="${t.coverBase64}" style="width:100%;height:100%;object-fit:cover">`; }
  else { mainCover.textContent = t ? initials(t.name) : 'üéµ'; mainCover.style.background = t ? gradientFromString(t.name) : ''; barCover.textContent = t ? initials(t.name) : 'üéµ'; barCover.style.background = t ? gradientFromString(t.name) : ''; }
  
  if(t){
    playerBar.style.display = 'flex';
    barTitle.textContent = t.name;
    barSub.textContent = `${Math.round((t.size||0)/1024)} KB`;
  } else {
    playerBar.style.display='none';
  }
}

function updatePlayButton(isPlaying) {
    playBtn.textContent = isPlaying ? '‚è∏ T·∫°m d·ª´ng' : '‚ñ∂Ô∏è Play';
    barPlay.textContent = isPlaying ? '‚è∏' : '‚ñ∂Ô∏è';
}

function playById(id){
  const t = tracks.find(x=>x.id===id); if(!t) return;
  idx = queue.indexOf(id);
  // check runtime file
  const rf = runtimeFiles.get(id);
  if(rf){
    audio.src = rf.url;
    audio.play().catch(()=>{});
    setNowUI(t);
    updatePlayButton(true);
    return;
  }
  // if saved in IDB, get blob
  if(t.saved){
    idbGet(id).then(rec=>{
      if(rec && rec.blob){
        const url = URL.createObjectURL(rec.blob);
        runtimeFiles.set(id,{file:rec.blob,url}); // Add to runtime for next plays
        audio.src = url; audio.play().catch(()=>{});
        setNowUI(t);
        updatePlayButton(true);
      } else {
        alert('Kh√¥ng t√¨m th·∫•y file l∆∞u trong IndexedDB. Vui l√≤ng import l·∫°i ho·∫∑c g·∫Øn file (üìé).');
        updatePlayButton(false);
      }
    }).catch(err=>{ console.error(err); alert('L·ªói ƒë·ªçc IndexedDB'); updatePlayButton(false); });
    return;
  }
  alert('Track ch·ªâ l∆∞u metadata. H√£y b·∫•m üìé ƒë·ªÉ th√™m file t∆∞∆°ng ·ª©ng (ch·ªâ c·∫ßn 1 l·∫ßn).');
  updatePlayButton(false);
}

// prev / next
function playNext(){
    if (shuffleMode && queue.length > 0) {
        idx = (idx + 1) % queue.length;
        playById(queue[idx]);
        return;
    }
    if(idx < queue.length-1){
        idx++;
        playById(queue[idx]);
    } else if(repeatMode==='all' && queue.length > 0){
        idx=0;
        playById(queue[idx]);
    } else {
        audio.pause();
        updatePlayButton(false);
    }
}
function playPrev(){ if(idx>0){ idx--; playById(queue[idx]); } }

// audio events
audio.addEventListener('timeupdate', ()=>{
  if(audio.duration){ const pct = (audio.currentTime/audio.duration)*100; seek.value = pct; barSeek.value = pct; timeLabel.textContent = `${fmtTime(audio.currentTime)} / ${fmtTime(audio.duration)}`; barTime.textContent = timeLabel.textContent; }
});
seek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; });
barSeek.addEventListener('input', e=>{ if(audio.duration) audio.currentTime = (e.target.value/100)*audio.duration; });

audio.addEventListener('ended', ()=>{ if(repeatMode==='one'){ audio.currentTime=0; audio.play(); } else playNext(); });
audio.addEventListener('pause', ()=> updatePlayButton(false));
audio.addEventListener('play', ()=> updatePlayButton(true));

// play/pause
playBtn.addEventListener('click', ()=>{
    if(!audio.src){
        if(queue.length > 0) playById(queue[0]);
        return;
    }
    if(audio.paused){
        audio.play().catch(e => console.error("Play failed:", e));
    } else {
        audio.pause();
    }
});
barPlay.addEventListener('click', ()=>{ playBtn.click(); });
prevBtn.addEventListener('click', playPrev); barPrev.addEventListener('click', playPrev);
nextBtn.addEventListener('click', playNext); barNext.addEventListener('click', playNext);

// shuffle / repeat
shuffleBtn.addEventListener('click', ()=>{
    shuffleMode = !shuffleMode;
    if (shuffleMode) {
        queue = shuffleArray(tracks.map(t=>t.id));
        if (idx !== -1) { // ƒê·∫∑t b√†i hi·ªán t·∫°i v·ªÅ ƒë·∫ßu queue shuffle
            const currentId = tracks[idx] ? tracks[idx].id : null;
            if (currentId) {
                queue = [currentId, ...queue.filter(id => id !== currentId)];
                idx = 0;
            }
        }
    } else {
        queue = tracks.map(t=>t.id);
        if (idx !== -1) idx = queue.indexOf(tracks[idx].id);
    }
    shuffleBtn.textContent = shuffleMode ? 'üîÄ ON' : 'üîÄ Shuffle';
});
repeatBtn.addEventListener('click', ()=>{
    repeatMode = repeatMode==='off'?'one':(repeatMode==='one'?'all':'off');
    updateStorageUI(); // C·∫≠p nh·∫≠t text n√∫t
});

// ---------- G·∫Øn file & Offline Save Toggle ----------
// Toggle Save Files
toggleSaveFiles.addEventListener('click', ()=>{
    saveFilesOffline = !saveFilesOffline;
    localStorage.setItem('saveFilesOffline', saveFilesOffline ? '1' : '0');
    updateStorageUI();
    alert(`T·ª± ƒë·ªông l∆∞u file ngo·∫°i tuy·∫øn: ${saveFilesOffline ? 'ƒê√É B·∫¨T' : 'ƒê√É T·∫ÆT'}`);
});

function attachFileToMeta(id){
  const fi = document.createElement('input'); fi.type='file'; fi.accept='audio/*';
  fi.onchange = async e=>{
    const f = e.target.files[0]; if(!f) return;
    // revoke old
    if(runtimeFiles.has(id)){ const old = runtimeFiles.get(id); try{ URL.revokeObjectURL(old.url);}catch(e){} }
    const url = URL.createObjectURL(f);
    runtimeFiles.set(id,{file:f,url});
    
    const t = tracks.find(x=>x.id===id);
    if(t) {
        // N·∫øu file c√≥ t√™n kh√°c, c·∫≠p nh·∫≠t
        if (t.name !== f.name) t.name = f.name;
        t.size = f.size;
        t.type = f.type;
    }

    // if saveFilesOffline on, store to IDB automatically
    if(saveFilesOffline){
        try {
            await idbPut(id, f, {name:f.name,type:f.type,size:f.size});
            if(t){ t.saved = true; }
            saveMeta();
            updateStorageUI();
            alert('File ƒë√£ g·∫Øn v√† l∆∞u offline th√†nh c√¥ng.');
        } catch(e) {
            console.warn('idb put err', e);
            alert('File ƒë√£ g·∫Øn t·∫°m th·ªùi nh∆∞ng kh√¥ng th·ªÉ l∆∞u offline.');
        }
    } else {
        alert('File ƒë√£ g·∫Øn v·ªõi metadata (t·∫°m th·ªùi). Reload trang s·∫Ω m·∫•t file n√†y tr·ª´ khi b·∫°n Export/Save offline.');
    }
    renderPlaylist(searchInput.value);
  };
  fi.click();
}

// ---------- Download individual track (if runtime exists or saved) ----------
async function downloadTrack(id){
  const rf = runtimeFiles.get(id);
  if(rf && rf.url){
    const a = document.createElement('a'); a.href = rf.url; a.download = tracks.find(t=>t.id===id).name; a.click(); return;
  }
  // else from IDB
  const rec = await idbGet(id);
  if(rec && rec.blob){
    const url = URL.createObjectURL(rec.blob);
    const a = document.createElement('a'); a.href = url; a.download = tracks.find(t=>t.id===id).name; a.click(); URL.revokeObjectURL(url);
    return;
  }
  alert('Kh√¥ng c√≥ file th·ª±c t·∫ø ƒë·ªÉ t·∫£i. H√£y g·∫Øn file (üìé) ho·∫∑c l∆∞u offline.');
}

// ---------- Remove track ----------
async function removeTrack(id){
  // stop playing if it's the current track
  const currentId = tracks[idx] ? tracks[idx].id : null;
  if(currentId === id) audio.pause();

  // remove runtime url
  if(runtimeFiles.has(id)){ const r = runtimeFiles.get(id); try{ URL.revokeObjectURL(r.url);}catch(e){} runtimeFiles.delete(id); }
  // remove saved IDB
  try{ await idbDelete(id); }catch(e){}
  tracks = tracks.filter(t=>t.id!==id);
  queue = tracks.map(t=>t.id);
  if(shuffleMode) queue = shuffleArray(tracks.map(t=>t.id));

  if(idx>=tracks.length) idx = tracks.length-1;
  if(idx < 0) setNowUI(null);

  saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
}

// ---------- Add files (input / drop) ----------
fileInput.addEventListener('change', async e=>{ if(e.target.files.length) await handleFiles(e.target.files); fileInput.value=''; });
async function handleFiles(fileList){
  for(const f of Array.from(fileList)){
    const id = uid();
    const tmeta = { id, name: f.name, size: f.size, type: f.type, coverBase64: null, saved: false };
    // try read ID3 cover if jsmediatags present
    if(window.jsmediatags){
      try{
        await new Promise((res,rej)=>{
          jsmediatags.read(f, {
            onSuccess: tag => {
              const picture = tag.tags.picture;
              if(picture){
                const base64 = arrayBufferToBase64(picture.data);
                const mime = picture.format || 'image/jpeg';
                tmeta.coverBase64 = `data:${mime};base64,${base64}`;
              }
              res();
            },
            onError: ()=> res()
          });
        });
      }catch(e){}
    }
    tracks.push(tmeta);
    // runtime file url
    const url = URL.createObjectURL(f);
    runtimeFiles.set(id,{file:f,url});
    // if user enabled saveFilesOffline, write to IDB immediately
    if(saveFilesOffline){ try{ await idbPut(id,f,{name:f.name,type:f.type,size:f.size}); tmeta.saved = true; }catch(e){ console.warn('idb put err', e); } }
  }
  queue = tracks.map(t=>t.id);
  if(shuffleMode) queue = shuffleArray(tracks.map(t=>t.id));

  saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
}

// cover input (global cover for new items)
coverInput.addEventListener('change', async e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=> {
    const base = reader.result;
    // set cover for last added track(s) ‚Äî apply to tracks that don't have cover
    for(let i=tracks.length-1;i>=0;i--){
      if(!tracks[i].coverBase64){ tracks[i].coverBase64 = base; } // B·ªè 'break' ƒë·ªÉ √°p d·ª•ng cho t·∫•t c·∫£ c√°c track M·ªöI CH∆ØA C√ì cover
    }
    saveMeta(); renderPlaylist(searchInput.value);
    alert('Cover ƒë√£ ƒë∆∞·ª£c √°p d·ª•ng cho c√°c track m·ªõi nh·∫•t ch∆∞a c√≥ cover.');
  };
  reader.readAsDataURL(f);
  coverInput.value='';
});

// drag & drop support
document.addEventListener('dragover', e=>e.preventDefault());
document.addEventListener('drop', async e=>{ e.preventDefault(); if(e.dataTransfer && e.dataTransfer.files && e.dataTransfer.files.length) await handleFiles(e.dataTransfer.files); });

// ---------- Export / Import ----------
exportBtn.addEventListener('click', async ()=>{
  if(tracks.length===0){ alert('Kh√¥ng c√≥ track ƒë·ªÉ export'); return; }
  if(!confirm('Export s·∫Ω t·∫°o file JSON c√≥ th·ªÉ l·ªõn (bao g·ªìm base64 c·ªßa file ƒë√£ l∆∞u trong IDB ho·∫∑c runtime). B·∫°n ch·∫Øc?')) return;
  const payload = {created:Date.now(), version:2, tracks:[]};
  for(const t of tracks){
    const rec = { name: t.name, size: t.size, type: t.type, cover: t.coverBase64 || null, base: null };
    // prefer IDB saved
    if(t.saved){
      const stored = await idbGet(t.id);
      if(stored && stored.blob){ rec.base = await blobToBase64(stored.blob); }
    } else {
      const rf = runtimeFiles.get(t.id);
      if(rf && rf.file){ rec.base = await blobToBase64(rf.file); }
    }
    payload.tracks.push(rec);
  }
  const blob = new Blob([JSON.stringify(payload)],{type:'application/json'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = `yuung_export_${new Date().toISOString().slice(0,10)}.yuung.json`; a.click();
});

importBtn.addEventListener('click', ()=>{
  const fi = document.createElement('input'); fi.type='file'; fi.accept='.json,application/json';
  fi.onchange = async e=>{
    const f = e.target.files[0]; if(!f) return;
    try{
      const txt = await f.text(); const p = JSON.parse(txt); if(!p.tracks) throw 'invalid';
      for(const item of p.tracks){
        const id = uid();
        const md = { id, name: item.name, size: item.size||0, type: item.type||'audio/mpeg', coverBase64: item.cover||null, saved:false };
        tracks.push(md);
        if(item.base){
          const blob = base64ToBlob(item.base, item.type||'audio/mpeg');
          const file = new File([blob], item.name, {type:item.type});
          const url = URL.createObjectURL(file);
          runtimeFiles.set(id,{file,url});
        }
      }
      queue = tracks.map(t=>t.id);
      if(shuffleMode) queue = shuffleArray(tracks.map(t=>t.id));
      saveMeta(); renderPlaylist(searchInput.value); updateStorageUI();
      alert(`Import th√†nh c√¥ng ${p.tracks.length} track!`);
    }catch(err){ console.error(err); alert('Import l·ªói. File JSON kh√¥ng h·ª£p l·ªá.'); }
  };
  fi.click();
});

// ---------- Save all / remove saved ----------
saveAllBtn.addEventListener('click', async ()=>{
  if(tracks.length===0){ alert('Ch∆∞a c√≥ track n√†o'); return; }
  if(!confirm('L∆∞u t·∫•t c·∫£ file runtime (ƒë√£ g·∫Øn) v√†o IndexedDB (t·ªën dung l∆∞·ª£ng). Ti·∫øp t·ª•c?')) return;
  for(const t of tracks){
    try{
      let blob = null;
      if(runtimeFiles.has(t.id)){ blob = runtimeFiles.get(t.id).file; }
      else {
        const rec = await idbGet(t.id);
        if(rec && rec.blob) blob = rec.blob;
      }
      if(blob){ await idbPut(t.id, blob, {name:t.name,type:t.type,size:t.size}); t.saved = true; }
    }catch(e){ console.warn('saveAll err', e); alert(`L·ªói l∆∞u file ${t.name}: ${e.message}`); }
  }
  saveMeta(); updateStorageUI(); alert('ƒê√£ l∆∞u t·∫•t c·∫£ file th√†nh c√¥ng!');
});

removeAllSavedBtn.addEventListener('click', async ()=>{
  if(!confirm('X√≥a t·∫•t c·∫£ file ƒë√£ l∆∞u trong IndexedDB (ch·ªâ x√≥a file, kh√¥ng x√≥a metadata)?')) return;
  await idbClear();
  for(const t of tracks) t.saved = false;
  saveMeta(); updateStorageUI();
  alert('ƒê√£ x√≥a t·∫•t c·∫£ file l∆∞u offline.');
});

// ---------- Download all (zip) ----------
downloadAllBtn.addEventListener('click', async ()=>{
  // collect blobs
  const files = [];
  for(const t of tracks){
    let file = null;
    if(runtimeFiles.has(t.id)) file = runtimeFiles.get(t.id).file;
    else {
      const rec = await idbGet(t.id);
      if(rec && rec.blob) file = rec.blob;
    }
    if (file) files.push({name:t.name,file:file});
  }

  if(files.length===0){ alert('Kh√¥ng c√≥ file th·ª±c t·∫ø ƒë·ªÉ t·∫£i. H√£y g·∫Øn file ho·∫∑c l∆∞u offline.'); return; }

  if(window.JSZip){
    const zip = new JSZip();
    files.forEach(f=> zip.file(f.name, f.file));
    const content = await zip.generateAsync({type:'blob'});
    const a = document.createElement('a'); a.href = URL.createObjectURL(content); a.download = 'yuung_tracks.zip'; a.click();
    URL.revokeObjectURL(a.href);
  } else {
    if(!confirm('JSZip ch∆∞a ƒë∆∞·ª£c t·∫£i. S·∫Ω t·∫£i t·ª´ng file m·ªôt (c√≥ th·ªÉ l√¢u). OK?')) return;
    for(const f of files){
      const url = URL.createObjectURL(f.file);
      const a = document.createElement('a'); a.href = url; a.download = f.name; a.click();
      URL.revokeObjectURL(url);
    }
  }
});

// ---------- Remove all tracks ----------
clearBtn.addEventListener('click', async ()=>{
  if(!confirm('X√≥a to√†n b·ªô playlist v√† file l∆∞u (metadata v√† file IDB)?')) return;
  audio.pause(); audio.src = '';
  runtimeFiles.forEach(r=>{ try{ URL.revokeObjectURL(r.url);}catch(e){} });
  runtimeFiles.clear();
  tracks=[]; queue=[]; idx=-1;
  await idbClear();
  saveMeta(); renderPlaylist(); updateStorageUI(); setNowUI(null);
  alert('ƒê√£ x√≥a to√†n b·ªô playlist v√† file l∆∞u.');
});

// ---------- PWA Installation (Placeholder) ----------
let deferredPrompt;
window.addEventListener('beforeinstallprompt', (e) => {
  e.preventDefault();
  deferredPrompt = e;
  installBtn.style.display = 'inline-block';
  installBtn.addEventListener('click', () => {
    installBtn.style.display = 'none';
    deferredPrompt.prompt();
    deferredPrompt.userChoice.then((choiceResult) => {
      console.log('User choice', choiceResult.outcome);
      deferredPrompt = null;
    });
  });
});
if (!window.matchMedia('(display-mode: standalone)').matches) {
    installBtn.style.display = 'inline-block';
} else {
    installBtn.style.display = 'none';
}


// ---------- Initialization ----------
loadMeta();
updateStorageUI();
renderPlaylist(searchInput.value);

// Attach event: search
searchInput.addEventListener('input', ()=> renderPlaylist(searchInput.value));

// Init seek bar values
seek.value = 0;
barSeek.value = 0;

// Update UI on load
updateStorageUI();

})(); // End IIFE
</script>
</body>
</html>
