<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Yuung Player V2.1 ‚Äî Optimized</title>
<meta name="theme-color" content="#0b7fa8" id="metaThemeColor">

<script src="https://unpkg.com/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
    /* ============================
       CSS VARIABLES & THEME
       ============================ */
    :root{
      --bg1: #f0fbff; --bg2: #e6f9ff;
      --card: #ffffff; --muted: #6b8b92; --text: #043242;
      --accent: #ff4757; --accent2: #00a6ff;
      --radius: 16px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    [data-theme="dark"]{
      --bg1: #03181d; --bg2: #07262e;
      --card: #0d1f27; --muted: #9fdff5; --text: #dff8ff;
      --accent: #ff6b87; --accent2: #06b3ff;
      --shadow: 0 10px 30px rgba(0,0,0,0.6);
    }

    /* GLOBAL RESET */
    html,body{height:100%;margin:0;font-family:'Segoe UI', Inter, sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);overflow-x:hidden;}
    *{box-sizing:border-box; outline:none; -webkit-tap-highlight-color: transparent;}
    
    /* UTILS */
    .wrap{max-width:1100px;margin:0 auto;padding:18px;padding-bottom:120px;}
    .btn{background:var(--card);border:0;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);font-size:14px;color:var(--text);transition:all .2s; user-select: none;}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.1);}
    .btn:active{transform:scale(0.96);}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700;}
    
    /* HEADER */
    header{display:flex;align-items:center;gap:14px;padding:14px;border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);}
    .logo{width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-size:24px;}

    /* LAYOUT GRID */
    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px;}
    @media (max-width:850px){ .grid{grid-template-columns:1fr;} }

    /* CARD & COVER */
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);}
    .cover-container{position:relative; width:100%; height:320px; border-radius:12px; overflow:hidden; box-shadow:0 10px 20px rgba(0,0,0,0.2); background: #000;}
    .cover{width:100%;height:100%;object-fit:cover;background:#222;display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;}
    
    /* VISUALIZER CANVAS */
    #visualizer{
        position: absolute; bottom:0; left:0; width:100%; height:100px;
        z-index: 2; pointer-events: none; opacity: 0.8;
    }

    /* PLAYLIST TRACKS */
    .playlist{display:flex;flex-direction:column;gap:10px; margin-top:10px;}
    .track{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);transition:0.2s; cursor: pointer;}
    .track:hover{transform:translateX(4px); background:var(--bg2);}
    .track.active{border: 2px solid var(--accent2); background:var(--bg2);}
    .t-cover{width:45px;height:45px;border-radius:8px;object-fit:cover;background:#ddd;flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff; overflow: hidden;}
    .t-info{flex:1;min-width:0;}
    .t-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis; font-size: 15px;}
    .t-sub{font-size:12px;opacity:0.7;}
    
    /* INPUTS */
    input[type=range]{-webkit-appearance:none;width:100%;height:6px;background:rgba(128,128,128,0.3);border-radius:4px;cursor:pointer;}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--accent);border-radius:50%;transition:transform .1s;}
    input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2);}

    /* BOTTOM PLAYER */
    .player-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:95%;max-width:1100px;background:rgba(20,20,20,0.95);backdrop-filter:blur(10px);padding:10px 12px;border-radius:16px;display:flex;align-items:center;gap:12px;color:white;z-index:100;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
    [data-theme="light"] .player-bar{background:rgba(255,255,255,0.95);color:#333; border: 1px solid #eee;}
    .bar-cover{width:45px;height:45px;border-radius:8px;object-fit:cover;}
    .bar-info{flex:1;min-width:0;}
    .bar-ctrls{display:flex;gap:8px;}
    @media(max-width:600px){ .bar-time, .hide-mobile{display:none;} .player-bar{bottom:10px; width:96%; padding:10px;} }

    /* LOADING OVERLAY */
    #loader{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);color:white;display:flex;flex-direction: column;gap: 10px; align-items:center;justify-content:center;z-index:999;font-size:18px;display:none;}
    .spinner {width: 40px;height: 40px;border: 4px solid #f3f3f3;border-top: 4px solid var(--accent);border-radius: 50%;animation: spin 1s linear infinite;}
    @keyframes spin {0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); }}

    /* PERFORMANCE TOGGLE */
    .switch-wrap{display:flex; align-items:center; gap:8px; font-size:13px; margin-top:10px; justify-content: center;}
</style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <div id="loaderText">ƒêang x·ª≠ l√Ω...</div>
</div>

<div class="wrap">
  <header>
    <div class="logo">üéµ</div>
    <div style="flex:1">
      <h2 style="margin:0; font-size: 20px;">Yuung Player V2.1</h2>
      <div style="font-size:12px;opacity:0.7">Optimized ¬∑ Low Latency</div>
    </div>
    <button class="btn" onclick="toggleTheme()">üåì</button>
  </header>

  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px">
    <label class="btn primary">
        ‚ûï Th√™m Nh·∫°c
        <input type="file" id="fileInput" accept="audio/*" multiple hidden>
    </label>
    <label class="btn">
        üñºÔ∏è Set Cover
        <input type="file" id="coverInput" accept="image/*" hidden>
    </label>
    <div style="flex:1"></div>
    <button class="btn" id="zipExportBtn">üì¶ Export</button>
    <label class="btn">
        üì• Import
        <input type="file" id="importInput" accept=".zip" hidden>
    </label>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="cover-container">
           <div id="mainCover" class="cover">üéß</div>
           <canvas id="visualizer" width="360" height="100"></canvas>
        </div>

        <div class="switch-wrap">
            <input type="checkbox" id="vizToggle" checked onchange="toggleVisualizer(this.checked)">
            <label for="vizToggle">B·∫≠t S√≥ng Nh·∫°c (T·∫Øt n·∫øu lag)</label>
        </div>

        <div style="text-align:center; margin-top:10px;">
           <h3 id="nowTitle" style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-size:18px;">‚Äî</h3>
           <div id="nowArtist" style="font-size:13px;opacity:0.7;margin-top:4px">Ch∆∞a ph√°t nh·∫°c</div>
        </div>

        <div style="margin-top:15px; display:flex; align-items:center; gap:10px">
           <span id="currentTime" style="font-size:12px;width:35px; text-align:right">0:00</span>
           <input id="seek" type="range" min="0" max="100" value="0">
           <span id="duration" style="font-size:12px;width:35px">0:00</span>
        </div>

        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:20px">
           <button class="btn" id="prevBtn" style="width:50px">‚èÆ</button>
           <button class="btn primary" id="playBtn" style="width:60px; height:60px; font-size:24px; border-radius:50%; padding:0; display:flex; align-items:center; justify-content:center">‚ñ∂Ô∏è</button>
           <button class="btn" id="nextBtn" style="width:50px">‚è≠</button>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px">
            <button class="btn" id="shuffleBtn">üîÄ Off</button>
            <button class="btn" id="repeatBtn">üîÅ Off</button>
            <button class="btn" onclick="clearAllData()" style="color:var(--accent)">üóëÔ∏è Reset</button>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <div style="display:flex; justify-content:space-between; align-items:center">
             <b>Tr·∫°ng th√°i l∆∞u tr·ªØ</b>
             <span id="storageStatus" style="font-size:12px">Checking...</span>
        </div>
        <div style="margin-top:8px; font-size:11px; opacity:0.7; line-height: 1.4;">
            Nh·∫°c ƒë∆∞·ª£c l∆∞u trong tr√¨nh duy·ªát. N·∫øu m√°y y·∫øu, h√£y t·∫Øt "S√≥ng Nh·∫°c" ƒë·ªÉ m∆∞·ª£t h∆°n.
        </div>
      </div>
    </div>

    <div class="card" style="height:fit-content">
       <input id="searchInput" placeholder="üîç T√¨m b√†i h√°t..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; background:transparent; color:var(--text); margin-bottom:10px">
       <div id="playlist" class="playlist"></div>
    </div>
  </div>
</div>

<div class="player-bar" id="playerBar" style="display:none">
   <div id="barCover" class="bar-cover" style="background:#777; display:flex; align-items:center; justify-content:center">üéµ</div>
   <div class="bar-info">
      <div id="barTitle" style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-size: 14px;">Title</div>
      <div id="barArtist" style="font-size:11px; opacity:0.8">Yuung Player</div>
   </div>
   <div class="bar-ctrls">
      <button class="btn" id="barPrev" style="padding:8px">‚èÆ</button>
      <button class="btn primary" id="barPlay" style="padding:8px 14px">‚ñ∂Ô∏è</button>
      <button class="btn" id="barNext" style="padding:8px">‚è≠</button>
   </div>
</div>

<script>
/* =========================================
   CORE LOGIC - V2.1 OPTIMIZED
   ========================================= */

// --- 1. CONFIG & STATE ---
const DB_NAME = 'yuung_db_v2';
const DB_STORE = 'files';
const META_KEY = 'yuung_meta_v2';

let tracks = [];
let queue = [];
let audio = new Audio();
let currentIndex = -1;
let isShuffle = false;
let repeatMode = 0; // 0:off, 1:all, 2:one
let currentBlobUrl = null; // Track current blob to revoke it

// Visualizer State
let audioCtx, analyser, dataArray, sourceNode;
let isVizOn = true;
let animationId = null;

// --- 2. INDEXED DB (Gi·ªØ nguy√™n logic c≈© nh∆∞ng th√™m check l·ªói) ---
const dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE, { keyPath: 'id' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
});

async function saveFileDB(id, blob) {
    const db = await dbPromise;
    return new Promise((res, rej) => {
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).put({ id, blob });
        tx.oncomplete = () => res();
        tx.onerror = (e) => rej(e);
    });
}

async function getFileDB(id) {
    try {
        const db = await dbPromise;
        return new Promise((res) => {
            const tx = db.transaction(DB_STORE, 'readonly');
            const req = tx.objectStore(DB_STORE).get(id);
            req.onsuccess = () => res(req.result ? req.result.blob : null);
            req.onerror = () => res(null);
        });
    } catch(e) { return null; }
}

async function deleteFileDB(id) {
    const db = await dbPromise;
    const tx = db.transaction(DB_STORE, 'readwrite');
    tx.objectStore(DB_STORE).delete(id);
}

async function clearDB() {
    const db = await dbPromise;
    const tx = db.transaction(DB_STORE, 'readwrite');
    tx.objectStore(DB_STORE).clear();
}

// --- 3. APP FUNCTIONS ---

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function loadMeta() {
    try {
        const raw = localStorage.getItem(META_KEY);
        if (raw) {
            tracks = JSON.parse(raw);
            // Quick integrity check
            if (!Array.isArray(tracks)) tracks = [];
            queue = tracks.map(t => t.id);
            renderPlaylist();
            updateStorageStatus();
        }
    } catch(e) { console.error("Meta load error", e); }
}

function saveMeta() {
    try {
        localStorage.setItem(META_KEY, JSON.stringify(tracks));
        updateStorageStatus();
    } catch(e) { alert("B·ªô nh·ªõ ƒë·∫ßy! H√£y x√≥a b·ªõt b√†i h√°t."); }
}

function updateStorageStatus() {
    document.getElementById('storageStatus').innerText = `${tracks.length} b√†i ƒë√£ l∆∞u`;
}

// --- 4. VISUALIZER & AUDIO SYSTEM (OPTIMIZED) ---

function initAudioSystem() {
    if(!audioCtx) {
        const AudioContext = window.AudioContext || window.webkitAudioContext;
        audioCtx = new AudioContext();
    }
    // Resume if suspended (common mobile issue)
    if(audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
    
    // Setup Analyser Node
    if(!analyser) {
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 64; // Gi·∫£m t·ª´ 128 xu·ªëng 64 cho m√°y y·∫øu (√≠t c·ªôt h∆°n, m∆∞·ª£t h∆°n)
        dataArray = new Uint8Array(analyser.frequencyBinCount);
    }

    // Connect Source ONCE (Fix l·ªói crash khi source ƒë√£ t·ªìn t·∫°i)
    if(!sourceNode) {
        try {
            sourceNode = audioCtx.createMediaElementSource(audio);
            sourceNode.connect(analyser);
            analyser.connect(audioCtx.destination);
        } catch(e) { console.log("Source already connected or error:", e); }
    }
}

function toggleVisualizer(isOn) {
    isVizOn = isOn;
    if(isOn && !audio.paused) drawVisualizer();
    else cancelAnimationFrame(animationId);
}

function drawVisualizer() {
    if(!isVizOn || audio.paused) return; // Stop loop if paused/off

    animationId = requestAnimationFrame(drawVisualizer);
    analyser.getByteFrequencyData(dataArray);
    
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    
    ctx.clearRect(0, 0, w, h);
    
    // Optimize: Reduce loop iterations
    const barWidth = (w / dataArray.length) * 2; 
    let x = 0;
    
    for(let i = 0; i < dataArray.length; i++) {
        const v = dataArray[i]; 
        const barHeight = (v / 255) * h;
        
        ctx.fillStyle = `rgba(${v + 50}, 150, 255, 0.8)`; 
        ctx.fillRect(x, h - barHeight, barWidth - 1, barHeight);
        x += barWidth;
    }
}

// --- 5. PLAYBACK LOGIC ---

async function playTrack(id) {
    // 1. K√≠ch ho·∫°t AudioContext (b·∫Øt bu·ªôc do browser policy)
    try {
        initAudioSystem();
    } catch(e) { console.error("Audio Init Failed", e); }

    const track = tracks.find(t => t.id === id);
    if (!track) return;

    // 2. Memory Cleanup: Revoke URL c≈© ƒë·ªÉ tr√°nh tr√†n RAM
    if (currentBlobUrl) {
        URL.revokeObjectURL(currentBlobUrl);
        currentBlobUrl = null;
    }

    // 3. Load File
    let blob = await getFileDB(id);
    if (!blob) {
        alert('Kh√¥ng t√¨m th·∫•y file nh·∫°c! C√≥ th·ªÉ ƒë√£ b·ªã x√≥a.');
        return;
    }

    currentBlobUrl = URL.createObjectURL(blob);
    currentIndex = queue.indexOf(id);
    
    audio.src = currentBlobUrl;
    
    // 4. Play Safe
    audio.play()
        .then(() => {
             updatePlayBtn(true);
             if(isVizOn) drawVisualizer();
        })
        .catch(e => {
            console.error("Play error:", e);
            updatePlayBtn(false);
            // N·∫øu l·ªói do User Interaction ch∆∞a c√≥, browser s·∫Ω ch·∫∑n. 
        });

    // 5. Update UI
    document.getElementById('nowTitle').innerText = track.name;
    document.getElementById('nowArtist').innerText = "ƒêang ph√°t...";
    document.getElementById('barTitle').innerText = track.name;
    document.getElementById('barArtist').innerText = "ƒêang ph√°t...";
    
    // Cover Handling
    const coverHtml = track.cover 
        ? `<img src="${track.cover}" style="width:100%;height:100%;object-fit:cover">`
        : `<div style="font-size:40px; color:#555">üéµ</div>`;
        
    document.getElementById('mainCover').innerHTML = coverHtml;
    document.getElementById('barCover').innerHTML = track.cover ? `<img src="${track.cover}" style="width:100%;height:100%;object-fit:cover">` : 'üéµ';
    
    renderPlaylist();
    document.getElementById('playerBar').style.display = 'flex';
    document.title = "‚ñ∂ " + track.name;

    // Media Session
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.name,
            artist: 'Yuung Player',
            artwork: track.cover ? [{ src: track.cover, sizes: '512x512', type: 'image/jpeg' }] : []
        });
    }
}

function togglePlay() {
    // Lu√¥n th·ª≠ resume context tr∆∞·ªõc khi play/pause
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

    if (audio.paused) {
        if(audio.src && audio.src !== window.location.href) {
            audio.play().then(() => {
                updatePlayBtn(true);
                if(isVizOn) drawVisualizer();
            });
        } else if(queue.length > 0) {
            playTrack(queue[0]);
        }
    } else {
        audio.pause();
        updatePlayBtn(false);
        cancelAnimationFrame(animationId);
    }
}

function updatePlayBtn(isPlaying) {
    const txt = isPlaying ? '‚è∏' : '‚ñ∂Ô∏è';
    document.getElementById('playBtn').innerText = txt;
    document.getElementById('barPlay').innerText = txt;
}

function nextTrack() {
    if(queue.length === 0) return;
    let nextIdx = currentIndex + 1;
    if(isShuffle) {
        nextIdx = Math.floor(Math.random() * queue.length);
    } else if (nextIdx >= queue.length) {
        nextIdx = 0; 
    }
    playTrack(queue[nextIdx]);
}

function prevTrack() {
    if(queue.length === 0) return;
    if (audio.currentTime > 3) {
        audio.currentTime = 0;
        return;
    }
    let prevIdx = currentIndex - 1;
    if (prevIdx < 0) prevIdx = queue.length - 1;
    playTrack(queue[prevIdx]);
}

// --- UI RENDERING (Optimized DOM) ---
function renderPlaylist() {
    const list = document.getElementById('playlist');
    const term = document.getElementById('searchInput').value.toLowerCase();
    
    // Performance: S·ª≠ d·ª•ng DocumentFragment ƒë·ªÉ gi·∫£m reflow
    const fragment = document.createDocumentFragment();
    
    tracks.forEach(t => {
        if (term && !t.name.toLowerCase().includes(term)) return;
        
        const el = document.createElement('div');
        el.className = `track ${t.id === (queue[currentIndex]) ? 'active' : ''}`;
        
        // Lazy load image text logic
        const imgTag = t.cover 
            ? `<img loading="lazy" src="${t.cover}" style="width:100%;height:100%;object-fit:cover;">` 
            : `<span>üéµ</span>`;

        el.innerHTML = `
            <div class="t-cover">${imgTag}</div>
            <div class="t-info">
                <div class="t-title">${t.name}</div>
                <div class="t-sub">${(t.size/1024/1024).toFixed(1)} MB</div>
            </div>
            <button class="btn" style="padding:5px 10px; color: #ff4757" onclick="event.stopPropagation(); deleteTrack('${t.id}')">‚úï</button>
        `;
        el.onclick = () => playTrack(t.id);
        fragment.appendChild(el);
    });
    
    list.innerHTML = '';
    list.appendChild(fragment);
}

// --- FILE HANDLING ---

function showLoader(show, text="ƒêang x·ª≠ l√Ω...") { 
    document.getElementById('loader').style.display = show ? 'flex' : 'none'; 
    document.getElementById('loaderText').innerText = text;
}

async function handleFileSelect(files) {
    showLoader(true, "ƒêang ƒë·ªçc file...");
    let count = 0;
    
    for (const file of files) {
        try {
            const id = uid();
            let cover = null;
            
            // Read ID3 Tag
            if (window.jsmediatags) {
                try {
                    cover = await new Promise(r => {
                        jsmediatags.read(file, {
                            onSuccess: tag => {
                                const pic = tag.tags.picture;
                                if (pic) {
                                    let base64String = "";
                                    for (let i = 0; i < pic.data.length; i++) base64String += String.fromCharCode(pic.data[i]);
                                    r("data:" + pic.format + ";base64," + window.btoa(base64String));
                                } else r(null);
                            },
                            onError: () => r(null)
                        });
                    });
                } catch(e){}
            }

            // Save to DB
            await saveFileDB(id, file);
            
            tracks.push({
                id: id,
                name: file.name.replace(/\.[^/.]+$/, ""),
                type: file.type,
                size: file.size,
                saved: true,
                cover: cover // L∆∞u √Ω: cover qu√° n·∫∑ng s·∫Ω l√†m ƒë·∫ßy localStorage
            });
            queue.push(id);
            count++;
        } catch(e) { console.error("File import failed", e); }
    }
    
    saveMeta();
    renderPlaylist();
    showLoader(false);
    if(count > 0 && audio.paused && currentIndex === -1) playTrack(tracks[tracks.length - count].id);
}

async function deleteTrack(id) {
    if(!confirm('X√≥a b√†i n√†y?')) return;
    await deleteFileDB(id);
    tracks = tracks.filter(t => t.id !== id);
    queue = tracks.map(t => t.id);
    if (currentIndex >= queue.length) currentIndex = 0;
    saveMeta();
    renderPlaylist();
}

async function clearAllData() {
    if(!confirm('X√ìA TO√ÄN B·ªò d·ªØ li·ªáu nh·∫°c offline?')) return;
    await clearDB();
    localStorage.removeItem(META_KEY);
    location.reload();
}

// --- ZIP EXPORT / IMPORT ---

document.getElementById('zipExportBtn').onclick = async () => {
    if(tracks.length === 0) return alert("Playlist tr·ªëng!");
    showLoader(true, "ƒêang n√©n file...");
    
    try {
        const zip = new JSZip();
        zip.file("playlist_meta.json", JSON.stringify(tracks));
        
        for(const t of tracks) {
            const blob = await getFileDB(t.id);
            if(blob) {
                const ext = t.type.includes('mpeg') ? 'mp3' : 'bin';
                zip.file(`${t.id}.${ext}`, blob);
            }
        }
        
        const content = await zip.generateAsync({type:"blob"});
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = `Yuung_Backup_${new Date().toISOString().slice(0,10)}.zip`;
        a.click();
    } catch(e) { alert("L·ªói Export: " + e.message); }
    
    showLoader(false);
};

document.getElementById('importInput').onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    showLoader(true, "ƒêang gi·∫£i n√©n...");

    try {
        if (!file.name.endsWith('.zip')) throw new Error("Ch·ªâ h·ªó tr·ª£ file .zip");
        const zip = await JSZip.loadAsync(file);
        
        if(zip.file("playlist_meta.json")) {
            const metaStr = await zip.file("playlist_meta.json").async("string");
            const newTracks = JSON.parse(metaStr);
            
            for(const t of newTracks) {
                // Find matching file in zip (id + any extension)
                const zipFileName = Object.keys(zip.files).find(n => n.startsWith(t.id));
                if(zipFileName) {
                    const blob = await zip.file(zipFileName).async("blob");
                    await saveFileDB(t.id, blob);
                    
                    if(!tracks.find(x => x.id === t.id)) {
                        tracks.push(t);
                        queue.push(t.id);
                    }
                }
            }
            saveMeta();
            renderPlaylist();
            alert("Import th√†nh c√¥ng!");
        } else {
            alert("File ZIP kh√¥ng h·ª£p l·ªá.");
        }
    } catch(err) {
        console.error(err);
        alert("L·ªói: " + err.message);
    }
    showLoader(false);
    e.target.value = '';
};

// --- EVENTS ---

document.getElementById('fileInput').onchange = e => handleFileSelect(e.target.files);
document.getElementById('coverInput').onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
        if (tracks.length > 0) {
            tracks.forEach(t => { if(!t.cover) t.cover = reader.result; });
            saveMeta(); renderPlaylist();
            if(currentIndex > -1) playTrack(queue[currentIndex]); 
        }
    };
    reader.readAsDataURL(f);
};

document.getElementById('playBtn').onclick = togglePlay;
document.getElementById('barPlay').onclick = togglePlay;
document.getElementById('nextBtn').onclick = nextTrack;
document.getElementById('barNext').onclick = nextTrack;
document.getElementById('prevBtn').onclick = prevTrack;
document.getElementById('barPrev').onclick = prevTrack;

document.getElementById('shuffleBtn').onclick = () => {
    isShuffle = !isShuffle;
    document.getElementById('shuffleBtn').innerText = isShuffle ? 'üîÄ ON' : 'üîÄ Off';
    document.getElementById('shuffleBtn').style.color = isShuffle ? 'var(--accent)' : 'var(--text)';
};
document.getElementById('repeatBtn').onclick = () => {
    repeatMode = (repeatMode + 1) % 3;
    const labels = ['üîÅ Off', 'üîÅ All', 'üîÇ One'];
    document.getElementById('repeatBtn').innerText = labels[repeatMode];
    document.getElementById('repeatBtn').style.color = repeatMode > 0 ? 'var(--accent)' : 'var(--text)';
};

// Time update & Seek
audio.addEventListener('timeupdate', () => {
    if(!audio.duration) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    document.getElementById('seek').value = pct;
    
    const fmt = s => {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return `${m}:${sec<10?'0':''}${sec}`;
    };
    document.getElementById('currentTime').innerText = fmt(audio.currentTime);
    document.getElementById('duration').innerText = fmt(audio.duration);
    
    if ('mediaSession' in navigator) {
        navigator.mediaSession.setPositionState({
            duration: audio.duration,
            playbackRate: audio.playbackRate,
            position: audio.currentTime
        });
    }
});

audio.addEventListener('ended', () => {
    if(repeatMode === 2) { audio.currentTime = 0; audio.play(); }
    else nextTrack();
});

document.getElementById('seek').oninput = (e) => {
    if(audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
};

document.getElementById('searchInput').oninput = renderPlaylist;

// Theme
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('metaThemeColor').setAttribute('content', isDark ? '#0b7fa8' : '#0d1f27');
    localStorage.setItem('yuung_theme', isDark ? 'light' : 'dark');
}
if(localStorage.getItem('yuung_theme') === 'dark') toggleTheme();

// Shortcuts
document.addEventListener('keydown', (e) => {
    if(e.target.tagName === 'INPUT') return;
    switch(e.code) {
        case 'Space': e.preventDefault(); togglePlay(); break;
        case 'ArrowRight': audio.currentTime += 5; break;
        case 'ArrowLeft': audio.currentTime -= 5; break;
    }
});

// PWA Handlers
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', togglePlay);
    navigator.mediaSession.setActionHandler('pause', togglePlay);
    navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
    navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
}

// Start
loadMeta();
</script>
</body>
</html>
