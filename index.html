<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<title>Yuung Player V2 ‚Äî Visualizer & Zip Support</title>
<meta name="theme-color" content="#0b7fa8" id="metaThemeColor">

<script src="https://unpkg.com/jsmediatags@3.9.5/dist/jsmediatags.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

<style>
    /* ============================
       CSS VARIABLES & THEME
       ============================ */
    :root{
      --bg1: #f0fbff; --bg2: #e6f9ff;
      --card: #ffffff; --muted: #6b8b92; --text: #043242;
      --accent: #ff4757; --accent2: #00a6ff;
      --radius: 16px;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
    }
    [data-theme="dark"]{
      --bg1: #03181d; --bg2: #07262e;
      --card: #0d1f27; --muted: #9fdff5; --text: #dff8ff;
      --accent: #ff6b87; --accent2: #06b3ff;
      --shadow: 0 10px 30px rgba(0,0,0,0.6);
    }

    /* GLOBAL RESET */
    html,body{height:100%;margin:0;font-family:'Segoe UI', Inter, sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);overflow-x:hidden;}
    *{box-sizing:border-box; outline:none;}
    
    /* UTILS */
    .wrap{max-width:1100px;margin:0 auto;padding:18px;padding-bottom:120px;}
    .btn{background:var(--card);border:0;padding:10px 14px;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);font-size:14px;color:var(--text);transition:all .2s;}
    .btn:hover{transform:translateY(-2px);filter:brightness(1.1);}
    .btn:active{transform:scale(0.96);}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2));color:white;font-weight:700;}
    
    /* HEADER */
    header{display:flex;align-items:center;gap:14px;padding:14px;border-radius:var(--radius);background:var(--card);box-shadow:var(--shadow);}
    .logo{width:50px;height:50px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent2));display:flex;align-items:center;justify-content:center;color:white;font-size:24px;}

    /* LAYOUT GRID */
    .grid{display:grid;grid-template-columns:360px 1fr;gap:20px;margin-top:20px;}
    @media (max-width:850px){ .grid{grid-template-columns:1fr;} }

    /* CARD & COVER */
    .card{background:var(--card);border-radius:14px;padding:16px;box-shadow:var(--shadow);}
    .cover-container{position:relative; width:100%; height:320px; border-radius:12px; overflow:hidden; box-shadow:0 10px 20px rgba(0,0,0,0.2);}
    .cover{width:100%;height:100%;object-fit:cover;background:#ccc;display:flex;align-items:center;justify-content:center;font-size:40px;color:#fff;}
    
    /* VISUALIZER CANVAS */
    #visualizer{
        position: absolute; bottom:0; left:0; width:100%; height:80px;
        background: linear-gradient(to top, rgba(0,0,0,0.8), transparent);
        z-index: 2; pointer-events: none;
    }

    /* PLAYLIST TRACKS */
    .playlist{display:flex;flex-direction:column;gap:10px; margin-top:10px;}
    .track{display:flex;align-items:center;gap:12px;padding:8px 12px;border-radius:10px;background:var(--card);box-shadow:var(--shadow);transition:0.2s;}
    .track:hover{transform:translateX(4px); background:var(--bg2);}
    .track.active{border: 2px solid var(--accent2);}
    .t-cover{width:50px;height:50px;border-radius:8px;object-fit:cover;background:#ddd;flex-shrink:0; display:flex; align-items:center; justify-content:center; font-weight:bold; color:#fff;}
    .t-info{flex:1;min-width:0;}
    .t-title{font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .t-sub{font-size:12px;opacity:0.7;}
    
    /* INPUTS */
    input[type=range]{-webkit-appearance:none;width:100%;height:6px;background:rgba(128,128,128,0.3);border-radius:4px;cursor:pointer;}
    input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;background:var(--accent);border-radius:50%;transition:transform .1s;}
    input[type=range]::-webkit-slider-thumb:hover{transform:scale(1.2);}

    /* BOTTOM PLAYER */
    .player-bar{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);width:95%;max-width:1100px;background:rgba(20,20,20,0.9);backdrop-filter:blur(10px);padding:12px;border-radius:16px;display:flex;align-items:center;gap:15px;color:white;z-index:100;box-shadow:0 10px 30px rgba(0,0,0,0.5);}
    [data-theme="light"] .player-bar{background:rgba(255,255,255,0.9);color:#333;}
    .bar-cover{width:50px;height:50px;border-radius:8px;object-fit:cover;}
    .bar-info{flex:1;min-width:0;}
    .bar-ctrls{display:flex;gap:10px;}
    @media(max-width:600px){ .bar-time, .hide-mobile{display:none;} .player-bar{bottom:10px; width:96%; padding:10px;} }

    /* LOADING OVERLAY */
    #loader{position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.7);color:white;display:flex;align-items:center;justify-content:center;z-index:999;font-size:20px;display:none;}
</style>
</head>
<body>

<div id="loader">ƒêang x·ª≠ l√Ω... vui l√≤ng ch·ªù</div>

<div class="wrap">
  <header>
    <div class="logo">üéµ</div>
    <div style="flex:1">
      <h2 style="margin:0">Yuung Player V2</h2>
      <div style="font-size:12px;opacity:0.7">Offline PWA ¬∑ Visualizer ¬∑ Zip Export</div>
    </div>
    <button class="btn" onclick="toggleTheme()">üåì Theme</button>
  </header>

  <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:15px">
    <label class="btn primary">
        ‚ûï Th√™m Nh·∫°c
        <input type="file" id="fileInput" accept="audio/*" multiple hidden>
    </label>
    <label class="btn">
        üñºÔ∏è Set Cover
        <input type="file" id="coverInput" accept="image/*" hidden>
    </label>
    <div style="flex:1"></div>
    <button class="btn" id="zipExportBtn">üì¶ Export ZIP</button>
    <label class="btn">
        üì• Import ZIP/JSON
        <input type="file" id="importInput" accept=".zip,.json" hidden>
    </label>
  </div>

  <div class="grid">
    <div>
      <div class="card">
        <div class="cover-container">
           <div id="mainCover" class="cover">üéß</div>
           <canvas id="visualizer" width="360" height="80"></canvas>
        </div>

        <div style="text-align:center; margin-top:15px;">
           <h3 id="nowTitle" style="margin:0;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">‚Äî</h3>
           <div id="nowArtist" style="font-size:13px;opacity:0.7;margin-top:4px">Ch∆∞a ph√°t nh·∫°c</div>
        </div>

        <div style="margin-top:15px; display:flex; align-items:center; gap:10px">
           <span id="currentTime" style="font-size:12px;width:40px">0:00</span>
           <input id="seek" type="range" min="0" max="100" value="0">
           <span id="duration" style="font-size:12px;width:40px;text-align:right">0:00</span>
        </div>

        <div style="display:flex; justify-content:center; align-items:center; gap:20px; margin-top:20px">
           <button class="btn" id="prevBtn">‚èÆ</button>
           <button class="btn primary" id="playBtn" style="padding:15px 25px; font-size:20px">‚ñ∂Ô∏è</button>
           <button class="btn" id="nextBtn">‚è≠</button>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:20px">
            <button class="btn" id="shuffleBtn">üîÄ Off</button>
            <button class="btn" id="repeatBtn">üîÅ Off</button>
            <button class="btn" onclick="clearAllData()">üóëÔ∏è X√≥a h·∫øt</button>
        </div>
      </div>

      <div class="card" style="margin-top:20px">
        <div style="display:flex; justify-content:space-between; align-items:center">
             <b>Tr·∫°ng th√°i l∆∞u tr·ªØ</b>
             <span id="storageStatus" style="font-size:12px">0 b√†i offline</span>
        </div>
        <div style="margin-top:8px; font-size:12px; opacity:0.7">
            T·ª± ƒë·ªông l∆∞u file v√†o tr√¨nh duy·ªát (IndexedDB) ƒë·ªÉ nghe offline.
        </div>
      </div>
    </div>

    <div class="card" style="height:fit-content">
       <input id="searchInput" placeholder="üîç T√¨m ki·∫øm b√†i h√°t..." style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc; background:transparent; color:var(--text); margin-bottom:10px">
       <div id="playlist" class="playlist"></div>
    </div>
  </div>
</div>

<div class="player-bar" id="playerBar" style="display:none">
   <div id="barCover" class="bar-cover" style="background:#777; display:flex; align-items:center; justify-content:center">üéµ</div>
   <div class="bar-info">
      <div id="barTitle" style="font-weight:bold; white-space:nowrap; overflow:hidden; text-overflow:ellipsis">Title</div>
      <div id="barArtist" style="font-size:12px; opacity:0.8">Artist</div>
   </div>
   <div class="bar-ctrls">
      <button class="btn" id="barPrev">‚èÆ</button>
      <button class="btn primary" id="barPlay">‚ñ∂Ô∏è</button>
      <button class="btn" id="barNext">‚è≠</button>
   </div>
</div>

<script>
/* =========================================
   CORE LOGIC - Yuung Player V2
   ========================================= */

// --- 1. CONFIG & STATE ---
const DB_NAME = 'yuung_db_v2';
const DB_STORE = 'files';
const META_KEY = 'yuung_meta_v2';

let tracks = []; // {id, name, type, size, saved:bool, cover: base64}
let queue = [];
let audio = new Audio();
let currentIndex = -1;
let isShuffle = false;
let repeatMode = 0; // 0:off, 1:all, 2:one
let runtimeUrls = new Map(); // id -> blobURL
let audioCtx, analyser, dataArray, sourceNode; // Web Audio API
let visualizerActive = false;

// --- 2. INDEXED DB HELPER ---
const dbPromise = new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
        const db = e.target.result;
        if (!db.objectStoreNames.contains(DB_STORE)) db.createObjectStore(DB_STORE, { keyPath: 'id' });
    };
    req.onsuccess = () => resolve(req.result);
    req.onerror = () => reject(req.error);
});

async function saveFileDB(id, blob) {
    const db = await dbPromise;
    return new Promise((res, rej) => {
        const tx = db.transaction(DB_STORE, 'readwrite');
        tx.objectStore(DB_STORE).put({ id, blob });
        tx.oncomplete = () => res();
        tx.onerror = () => rej();
    });
}

async function getFileDB(id) {
    const db = await dbPromise;
    return new Promise((res) => {
        const req = db.transaction(DB_STORE).objectStore(DB_STORE).get(id);
        req.onsuccess = () => res(req.result ? req.result.blob : null);
        req.onerror = () => res(null);
    });
}

async function deleteFileDB(id) {
    const db = await dbPromise;
    const tx = db.transaction(DB_STORE, 'readwrite');
    tx.objectStore(DB_STORE).delete(id);
}

async function clearDB() {
    const db = await dbPromise;
    const tx = db.transaction(DB_STORE, 'readwrite');
    tx.objectStore(DB_STORE).clear();
}

// --- 3. APP FUNCTIONS ---

function uid() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }

function loadMeta() {
    const raw = localStorage.getItem(META_KEY);
    if (raw) {
        tracks = JSON.parse(raw);
        queue = tracks.map(t => t.id);
        renderPlaylist();
        updateStorageStatus();
    }
}

function saveMeta() {
    localStorage.setItem(META_KEY, JSON.stringify(tracks));
    updateStorageStatus();
}

function updateStorageStatus() {
    const saved = tracks.filter(t => t.saved).length;
    document.getElementById('storageStatus').innerText = `${saved}/${tracks.length} b√†i ƒë√£ l∆∞u offline`;
}

// Visualizer Setup
function setupVisualizer() {
    if(audioCtx) return;
    try {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 128; // ƒê·ªô chi ti·∫øt c·ªßa c·ªôt s√≥ng (c√†ng cao c√†ng m·ªãn nh∆∞ng n·∫∑ng)
        
        // K·∫øt n·ªëi audio element v√†o graph
        sourceNode = audioCtx.createMediaElementSource(audio);
        sourceNode.connect(analyser);
        analyser.connect(audioCtx.destination);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        visualizerActive = true;
        drawVisualizer();
    } catch(e) { console.log("Visualizer start failed (user interaction needed first)"); }
}

function drawVisualizer() {
    if(!visualizerActive) return;
    requestAnimationFrame(drawVisualizer);
    
    analyser.getByteFrequencyData(dataArray);
    
    const canvas = document.getElementById('visualizer');
    const ctx = canvas.getContext('2d');
    const w = canvas.width;
    const h = canvas.height;
    
    ctx.clearRect(0, 0, w, h);
    
    const barWidth = (w / dataArray.length) * 2.5;
    let x = 0;
    
    for(let i = 0; i < dataArray.length; i++) {
        let barHeight = dataArray[i] / 2; // scale height
        
        // M√†u s·∫Øc d·ª±a tr√™n chi·ªÅu cao
        ctx.fillStyle = `rgb(${barHeight + 100}, 50, 150)`; 
        
        // V·∫Ω c·ªôt (cƒÉn ƒë√°y)
        ctx.fillRect(x, h - barHeight, barWidth, barHeight);
        x += barWidth + 1;
    }
}

// Play Logic
async function playTrack(id) {
    // K√≠ch ho·∫°t AudioContext n·∫øu ch∆∞a ch·∫°y (y√™u c·∫ßu user gesture)
    if (!audioCtx) setupVisualizer();
    if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();

    const track = tracks.find(t => t.id === id);
    if (!track) return;

    let url = runtimeUrls.get(id);
    
    if (!url) {
        // Th·ª≠ l·∫•y t·ª´ DB
        const blob = await getFileDB(id);
        if (blob) {
            url = URL.createObjectURL(blob);
            runtimeUrls.set(id, url); // Cache url
        } else {
            alert('File b√†i h√°t kh√¥ng t·ªìn t·∫°i (ch∆∞a import ho·∫∑c l·ªói t·∫£i).');
            return;
        }
    }

    currentIndex = queue.indexOf(id);
    audio.src = url;
    audio.play()
         .then(() => updatePlayBtn(true))
         .catch(e => console.error(e));

    // Update UI
    document.getElementById('nowTitle').innerText = track.name;
    document.getElementById('barTitle').innerText = track.name;
    
    // Cover update
    const coverHtml = track.cover 
        ? `<img src="${track.cover}" style="width:100%;height:100%;object-fit:cover">`
        : `<div style="font-size:40px; color:#555">üéµ</div>`;
        
    document.getElementById('mainCover').innerHTML = coverHtml;
    document.getElementById('barCover').innerHTML = track.cover ? `<img src="${track.cover}" style="width:100%;height:100%;object-fit:cover">` : 'üéµ';
    
    // Highlight playlist
    renderPlaylist();
    document.getElementById('playerBar').style.display = 'flex';
    
    // Update Meta Title
    document.title = "‚ñ∂ " + track.name;
    
    // Media Session (Hi·ªÉn th·ªã tr√™n m√†n h√¨nh kh√≥a ƒëi·ªán tho·∫°i)
    if ('mediaSession' in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
            title: track.name,
            artist: 'Yuung Player',
            artwork: track.cover ? [{ src: track.cover, sizes: '512x512', type: 'image/jpeg' }] : []
        });
    }
}

function togglePlay() {
    if (audio.paused) {
        if(audio.src) audio.play();
        else if(queue.length > 0) playTrack(queue[0]);
    } else {
        audio.pause();
    }
    updatePlayBtn(!audio.paused);
}

function updatePlayBtn(isPlaying) {
    const txt = isPlaying ? '‚è∏' : '‚ñ∂Ô∏è';
    document.getElementById('playBtn').innerText = txt;
    document.getElementById('barPlay').innerText = txt;
}

function nextTrack() {
    if(queue.length === 0) return;
    let nextIdx = currentIndex + 1;
    if(isShuffle) {
        nextIdx = Math.floor(Math.random() * queue.length);
    } else if (nextIdx >= queue.length) {
        nextIdx = 0; // Loop list
    }
    playTrack(queue[nextIdx]);
}

function prevTrack() {
    if(queue.length === 0) return;
    let prevIdx = currentIndex - 1;
    if (audio.currentTime > 3) {
        audio.currentTime = 0; // Replay current if played > 3s
        return;
    }
    if (prevIdx < 0) prevIdx = queue.length - 1;
    playTrack(queue[prevIdx]);
}

// Render UI
function renderPlaylist() {
    const list = document.getElementById('playlist');
    const term = document.getElementById('searchInput').value.toLowerCase();
    list.innerHTML = '';
    
    tracks.forEach(t => {
        if (!t.name.toLowerCase().includes(term)) return;
        
        const el = document.createElement('div');
        el.className = `track ${t.id === (queue[currentIndex]) ? 'active' : ''}`;
        el.innerHTML = `
            <div class="t-cover">
                ${t.cover ? `<img src="${t.cover}" style="width:100%;height:100%;object-fit:cover;border-radius:6px">` : (t.name[0].toUpperCase())}
            </div>
            <div class="t-info">
                <div class="t-title">${t.name}</div>
                <div class="t-sub">${(t.size/1024/1024).toFixed(1)} MB ${t.saved ? '‚Ä¢ üíæ Saved' : ''}</div>
            </div>
            <button class="btn" style="padding:5px 10px" onclick="event.stopPropagation(); deleteTrack('${t.id}')">‚úï</button>
        `;
        el.onclick = () => playTrack(t.id);
        list.appendChild(el);
    });
}

// --- 4. FILE HANDLING ---

function showLoader(show) { document.getElementById('loader').style.display = show ? 'flex' : 'none'; }

async function handleFileSelect(files) {
    showLoader(true);
    let count = 0;
    
    for (const file of files) {
        const id = uid();
        let cover = null;
        
        // ƒê·ªçc tag (ID3) ƒë·ªÉ l·∫•y cover
        if (window.jsmediatags) {
            try {
                cover = await new Promise(r => {
                    jsmediatags.read(file, {
                        onSuccess: tag => {
                            const pic = tag.tags.picture;
                            if (pic) {
                                let base64String = "";
                                for (let i = 0; i < pic.data.length; i++) base64String += String.fromCharCode(pic.data[i]);
                                r("data:" + pic.format + ";base64," + window.btoa(base64String));
                            } else r(null);
                        },
                        onError: () => r(null)
                    });
                });
            } catch(e){}
        }

        // L∆∞u v√†o IndexedDB
        await saveFileDB(id, file);
        
        tracks.push({
            id: id,
            name: file.name.replace(/\.[^/.]+$/, ""), // remove extension
            type: file.type,
            size: file.size,
            saved: true,
            cover: cover
        });
        queue.push(id);
        count++;
    }
    
    saveMeta();
    renderPlaylist();
    showLoader(false);
    if(count > 0 && audio.paused && currentIndex === -1) playTrack(tracks[tracks.length - count].id);
}

async function deleteTrack(id) {
    if(!confirm('X√≥a b√†i n√†y kh·ªèi th∆∞ vi·ªán?')) return;
    await deleteFileDB(id);
    tracks = tracks.filter(t => t.id !== id);
    queue = tracks.map(t => t.id);
    if (currentIndex >= queue.length) currentIndex = 0;
    saveMeta();
    renderPlaylist();
}

async function clearAllData() {
    if(!confirm('X√ìA TO√ÄN B·ªò d·ªØ li·ªáu nh·∫°c offline?')) return;
    await clearDB();
    tracks = [];
    queue = [];
    runtimeUrls.clear();
    saveMeta();
    location.reload();
}

// --- 5. EXPORT / IMPORT (ZIP) ---

document.getElementById('zipExportBtn').onclick = async () => {
    if(tracks.length === 0) return alert("Playlist tr·ªëng!");
    showLoader(true);
    const zip = new JSZip();
    
    // 1. T·∫°o file metadata.json
    zip.file("playlist_meta.json", JSON.stringify(tracks));
    
    // 2. Loop qua t·ª´ng track v√† l·∫•y Blob t·ª´ IndexedDB ƒë·ªÉ n√©n
    for(const t of tracks) {
        const blob = await getFileDB(t.id);
        if(blob) {
            // ƒê·∫∑t t√™n file l√† id ƒë·ªÉ tr√°nh tr√πng t√™n b√†i h√°t
            const ext = t.type.includes('mpeg') ? 'mp3' : (t.type.split('/')[1] || 'bin');
            zip.file(`${t.id}.${ext}`, blob);
        }
    }
    
    // 3. Generate Zip
    zip.generateAsync({type:"blob"}).then(function(content) {
        const a = document.createElement("a");
        a.href = URL.createObjectURL(content);
        a.download = `Yuung_Playlist_Backup_${Date.now()}.zip`;
        a.click();
        showLoader(false);
    });
};

document.getElementById('importInput').onchange = async (e) => {
    const file = e.target.files[0];
    if(!file) return;
    showLoader(true);

    try {
        if(file.name.endsWith('.json')) {
            // Legacy Import (Old version)
            const text = await file.text();
            alert("Vui l√≤ng d√πng b·∫£n backup ZIP m·ªõi. B·∫£n JSON c≈© kh√¥ng ch·ª©a file nh·∫°c.");
        } 
        else if (file.name.endsWith('.zip')) {
            const zip = await JSZip.loadAsync(file);
            
            // ƒê·ªçc metadata
            if(zip.file("playlist_meta.json")) {
                const metaStr = await zip.file("playlist_meta.json").async("string");
                const newTracks = JSON.parse(metaStr);
                
                for(const t of newTracks) {
                    // Ki·ªÉm tra xem ID b√†i h√°t c√≥ trong file zip kh√¥ng
                    // T√¨m file b·∫Øt ƒë·∫ßu b·∫±ng ID
                    const zipFileName = Object.keys(zip.files).find(n => n.startsWith(t.id));
                    if(zipFileName) {
                        const blob = await zip.file(zipFileName).async("blob");
                        // C·∫≠p nh·∫≠t l·∫°i type ch√≠nh x√°c t·ª´ blob n·∫øu c·∫ßn
                        await saveFileDB(t.id, blob);
                        
                        // Check duplicate
                        if(!tracks.find(x => x.id === t.id)) {
                            tracks.push(t);
                            queue.push(t.id);
                        }
                    }
                }
                saveMeta();
                renderPlaylist();
                alert("Import th√†nh c√¥ng!");
            } else {
                alert("File ZIP kh√¥ng ƒë√∫ng ƒë·ªãnh d·∫°ng backup c·ªßa Yuung Player.");
            }
        }
    } catch(err) {
        console.error(err);
        alert("L·ªói khi ƒë·ªçc file backup.");
    }
    showLoader(false);
    e.target.value = '';
};

// --- 6. EVENT LISTENERS ---

// Input Events
document.getElementById('fileInput').onchange = e => handleFileSelect(e.target.files);
document.getElementById('coverInput').onchange = e => {
    const f = e.target.files[0];
    if(!f) return;
    const reader = new FileReader();
    reader.onload = () => {
        // Apply cover to currently playing or all tracks without cover?
        // Let's apply to currently playing only for safety, or prompt
        if (tracks.length > 0) {
            tracks.forEach(t => { if(!t.cover) t.cover = reader.result; }); // Apply to all missing
            saveMeta(); renderPlaylist();
            if(currentIndex > -1) playTrack(queue[currentIndex]); // Refresh UI
            alert("ƒê√£ c·∫≠p nh·∫≠t cover cho c√°c b√†i thi·∫øu ·∫£nh.");
        }
    };
    reader.readAsDataURL(f);
};

// Player Controls
document.getElementById('playBtn').onclick = togglePlay;
document.getElementById('barPlay').onclick = togglePlay;
document.getElementById('nextBtn').onclick = nextTrack;
document.getElementById('barNext').onclick = nextTrack;
document.getElementById('prevBtn').onclick = prevTrack;
document.getElementById('barPrev').onclick = prevTrack;

document.getElementById('shuffleBtn').onclick = () => {
    isShuffle = !isShuffle;
    document.getElementById('shuffleBtn').innerText = isShuffle ? 'üîÄ ON' : 'üîÄ Off';
    document.getElementById('shuffleBtn').style.color = isShuffle ? 'var(--accent)' : 'var(--text)';
};
document.getElementById('repeatBtn').onclick = () => {
    repeatMode = (repeatMode + 1) % 3;
    const labels = ['üîÅ Off', 'üîÅ All', 'üîÇ One'];
    document.getElementById('repeatBtn').innerText = labels[repeatMode];
    document.getElementById('repeatBtn').style.color = repeatMode > 0 ? 'var(--accent)' : 'var(--text)';
};

// Audio Events
audio.addEventListener('timeupdate', () => {
    if(!audio.duration) return;
    const pct = (audio.currentTime / audio.duration) * 100;
    document.getElementById('seek').value = pct;
    
    const fmt = s => {
        const m = Math.floor(s/60);
        const sec = Math.floor(s%60);
        return `${m}:${sec<10?'0':''}${sec}`;
    };
    document.getElementById('currentTime').innerText = fmt(audio.currentTime);
    document.getElementById('duration').innerText = fmt(audio.duration);
    
    // Update Media Session Position
    if ('mediaSession' in navigator) {
        navigator.mediaSession.setPositionState({
            duration: audio.duration,
            playbackRate: audio.playbackRate,
            position: audio.currentTime
        });
    }
});
audio.addEventListener('ended', () => {
    if(repeatMode === 2) { audio.currentTime = 0; audio.play(); }
    else nextTrack();
});

// Seek Bar
document.getElementById('seek').oninput = (e) => {
    if(audio.duration) audio.currentTime = (e.target.value / 100) * audio.duration;
};

// Search
document.getElementById('searchInput').oninput = renderPlaylist;

// Theme Toggle
function toggleTheme() {
    const html = document.documentElement;
    const isDark = html.getAttribute('data-theme') === 'dark';
    html.setAttribute('data-theme', isDark ? 'light' : 'dark');
    document.getElementById('metaThemeColor').setAttribute('content', isDark ? '#0b7fa8' : '#0d1f27');
    localStorage.setItem('yuung_theme', isDark ? 'light' : 'dark');
}
// Init Theme
if(localStorage.getItem('yuung_theme') === 'dark') toggleTheme();

// Keyboard Shortcuts
document.addEventListener('keydown', (e) => {
    if(e.target.tagName === 'INPUT') return; // Ignore if typing in search
    switch(e.code) {
        case 'Space': e.preventDefault(); togglePlay(); break;
        case 'ArrowRight': audio.currentTime += 5; break;
        case 'ArrowLeft': audio.currentTime -= 5; break;
        case 'ArrowUp': audio.volume = Math.min(1, audio.volume + 0.1); break;
        case 'ArrowDown': audio.volume = Math.max(0, audio.volume - 0.1); break;
    }
});

// Init App
loadMeta();

// PWA: Media Session Handlers
if ('mediaSession' in navigator) {
    navigator.mediaSession.setActionHandler('play', togglePlay);
    navigator.mediaSession.setActionHandler('pause', togglePlay);
    navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
    navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
}

</script>
</body>
</html>
